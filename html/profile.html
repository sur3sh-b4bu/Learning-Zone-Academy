<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile | Gov Learn</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        .profile-hero {
            padding: 140px 0 80px;
            background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
            position: relative;
            overflow: hidden;
            min-height: 100vh;
        }

        /* Floating 3D orbs for background consistency */
        .profile-hero::before {
            content: '';
            position: absolute;
            top: -100px;
            right: -100px;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(16, 185, 129, 0.12) 0%, transparent 70%);
            border-radius: 50%;
            animation: floatOrb 10s ease-in-out infinite;
        }

        .profile-container {
            max-width: 900px;
            margin: 0 auto;
            perspective: 1000px;
            position: relative;
            z-index: 1;
        }

        .profile-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 32px;
            padding: 50px;
            box-shadow: var(--shadow-3d);
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 50px;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1);
            transform-style: preserve-3d;
        }

        .profile-card:hover {
            transform: rotateY(-3deg) rotateX(2deg);
        }

        @media (max-width: 768px) {
            .profile-card {
                grid-template-columns: 1fr;
                text-align: center;
                padding: 40px 24px;
            }
        }

        .profile-avatar-wrapper {
            position: relative;
            transform-style: preserve-3d;
        }

        .profile-avatar {
            width: 180px;
            height: 180px;
            background: linear-gradient(135deg, var(--primary-light) 0%, #a7f3d0 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5rem;
            color: var(--primary-green);
            font-weight: 800;
            margin: 0 auto;
            border: 8px solid white;
            box-shadow: var(--shadow-md);
            transform: translateZ(30px);
            transition: transform 0.4s;
        }

        .profile-card:hover .profile-avatar {
            transform: translateZ(50px) scale(1.05);
            box-shadow: var(--shadow-lg);
        }

        .profile-info {
            transform: translateZ(20px);
        }

        .profile-info h1 {
            font-size: 2.5rem;
            color: var(--primary-dark);
            margin-bottom: 8px;
            letter-spacing: -1px;
            font-weight: 800;
        }

        .profile-info p {
            color: var(--text-muted);
            margin-bottom: 24px;
            font-size: 1.1rem;
        }

        .badge-large {
            display: inline-block;
            padding: 10px 24px;
            border-radius: 99px;
            font-weight: 800;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .badge-free {
            background: #f1f5f9;
            color: #64748b;
        }

        .badge-pro {
            background: linear-gradient(135deg, var(--primary-green), var(--accent-teal));
            color: white;
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .profile-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-top: 32px;
            padding-top: 32px;
            border-top: 1px solid rgba(16, 185, 129, 0.1);
        }

        .stat-box {
            text-align: center;
            padding: 16px;
            background: rgba(16, 185, 129, 0.03);
            border-radius: 20px;
            transition: background 0.3s;
        }

        .stat-box:hover {
            background: rgba(16, 185, 129, 0.08);
        }

        .stat-box span {
            display: block;
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-box strong {
            font-size: 1.3rem;
            color: var(--primary-dark);
            font-weight: 800;
        }
    </style>
</head>

<body>
    <nav>
        <div class="container nav-content">
            <a href="index.html" class="logo">Gov<span>Learn</span></a>
            <button type="button" class="mobile-menu-toggle" onclick="toggleNav()">
                <span></span><span></span><span></span>
            </button>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="exams-hub.html">Exams Hub</a></li>
                <li><a href="mock-tests.html">Mock Tests</a></li>
                <li><a href="materials.html">Materials</a></li>
                <li><a href="current-affairs.html">Current Affairs</a></li>
                <li><a href="videos.html">Videos</a></li>
                <li id="profile-nav-link"><a href="profile.html" class="active">Profile</a></li>
                <li id="logout-btn"><button type="button" class="btn-primary" onclick="logout()"
                        style="background: #ef4444;">Logout</button></li>
            </ul>
        </div>
    </nav>

    <div class="profile-hero">
        <div class="container profile-container">
            <div class="profile-card fade-in" id="profile-content">
                <div class="profile-avatar-wrapper">
                    <div class="profile-avatar" id="user-avatar">?</div>
                </div>
                <div class="profile-info">
                    <span id="user-plan-badge" class="badge-large">Loading...</span>
                    <h1 id="user-name">Loading...</h1>
                    <p id="user-email">Loading...</p>

                    <div class="profile-stats">
                        <div class="stat-box">
                            <span>Enrolled On</span>
                            <strong id="user-enrolled">...</strong>
                        </div>
                        <div class="stat-box">
                            <span>Last Login</span>
                            <strong id="user-last-login">...</strong>
                        </div>
                    </div>

                    <div style="margin-top: 40px; display: flex; gap: 20px;">
                        <a href="mock-tests.html" class="btn-primary" style="flex: 1; text-align: center;">Start
                            Learning</a>
                        <button type="button" class="btn-primary"
                            style="flex: 1; background: white; border: 2px solid var(--primary-green); color: var(--primary-green); box-shadow: none;"
                            onclick="toggleModal('edit-modal')">Edit Profile</button>
                    </div>
                </div>
            </div>

            <!-- Dashboard sections -->
            <div class="grid-2 fade-in"
                style="margin-top: 40px; gap: 24px; grid-template-columns: 2fr 1fr; align-items: start;">

                <!-- Main Content Area -->
                <div style="display: flex; flex-direction: column; gap: 40px;">

                    <!-- Activity Tracking -->
                    <div class="card glass hover-3d" style="padding: 40px; border-radius: 24px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <h3 style="margin: 0; font-size: 1.5rem; color: var(--primary-dark); font-weight: 800;">My
                                Recent Activity</h3>
                            <span
                                style="font-size: 0.85rem; font-weight: 700; color: var(--primary-green); background: var(--primary-light); padding: 4px 12px; border-radius: 20px;">Live
                                Updates</span>
                        </div>
                        <div id="activity-list" style="display: flex; flex-direction: column; gap: 16px;">
                            <div class="stat-box"
                                style="display: flex; justify-content: space-between; align-items: center; padding: 20px; background: rgba(255,255,255,0.6); border: 1px solid rgba(16, 185, 129, 0.1); border-radius: 16px; transition: all 0.3s ease;">
                                <div style="display: flex; align-items: center; gap: 16px;">
                                    <div
                                        style="width: 48px; height: 48px; border-radius: 12px; background: #e0f2fe; color: #0284c7; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold;">
                                        T</div>
                                    <div>
                                        <span
                                            style="font-size: 0.75rem; font-weight: 700; color: #64748b; letter-spacing: 1px;">MOCK
                                            TEST</span>
                                        <p
                                            style="font-weight: 800; color: var(--primary-dark); margin: 4px 0 0 0; font-size: 1.1rem;">
                                            History - Sectional 1</p>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <strong
                                        style="color: var(--primary-green); font-size: 1.4rem; font-weight: 800;">88%</strong>
                                    <span
                                        style="display: block; font-size: 0.75rem; color: #64748b; margin-top: 4px;">Score</span>
                                </div>
                            </div>
                            <div class="stat-box"
                                style="display: flex; justify-content: space-between; align-items: center; padding: 20px; background: rgba(255,255,255,0.6); border: 1px solid rgba(16, 185, 129, 0.1); border-radius: 16px; transition: all 0.3s ease;">
                                <div style="display: flex; align-items: center; gap: 16px;">
                                    <div
                                        style="width: 48px; height: 48px; border-radius: 12px; background: #fef3c7; color: #d97706; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold;">
                                        V</div>
                                    <div>
                                        <span
                                            style="font-size: 0.75rem; font-weight: 700; color: #64748b; letter-spacing: 1px;">VIDEO
                                            COURSE</span>
                                        <p
                                            style="font-weight: 800; color: var(--primary-dark); margin: 4px 0 0 0; font-size: 1.1rem;">
                                            Indian Polity - Chapter 4</p>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <strong
                                        style="color: var(--text-muted); font-size: 1rem; font-weight: 700; background: #f1f5f9; padding: 6px 12px; border-radius: 20px;">Watched</strong>
                                </div>
                            </div>
                        </div>
                    </div>



                </div>

                <!-- Sidebar Area -->
                <div style="display: flex; flex-direction: column; gap: 40px;">



                    <!-- Admin Portal Link (Hidden by default) -->
                    <div id="admin-dashboard-link" class="card glass hover-3d"
                        style="display: none; padding: 40px; background: linear-gradient(135deg, white, #fef2f2); border: 2px dashed #fca5a5; text-align: center; border-radius: 24px;">
                        <div
                            style="width: 64px; height: 64px; background: #fee2e2; color: #ef4444; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; margin: 0 auto 20px; font-weight: 900;">
                            A
                        </div>
                        <h3 style="margin-bottom: 12px; color: #ef4444; font-size: 1.4rem; font-weight: 800;">Admin
                            Panel</h3>
                        <p style="font-size: 0.95rem; color: #64748b; margin-bottom: 24px; line-height: 1.5;">Manage
                            tests, students, and platform settings.</p>
                        <a href="admin.html" class="btn-primary"
                            style="background: #ef4444; width: 100%; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);">Go
                            to Dashboard</a>
                    </div>
                </div>
            </div>

            <!-- Bookmarks Section -->
            <div class="card glass hover-3d fade-in" style="margin-top: 40px; padding: 40px; border-radius: 24px;">
                <h3 style="margin-bottom: 24px; font-size: 1.5rem; color: var(--primary-dark); font-weight: 800;">My
                    Bookmarks</h3>
                <div class="exam-grid" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 24px;">
                    <div class="info-card"
                        style="margin: 0; padding: 24px; background: white; border: 1px solid #e2e8f0; border-radius: 16px; transition: transform 0.3s, box-shadow 0.3s;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                            <span
                                style="display: inline-block; width: 8px; height: 8px; background: #ef4444; border-radius: 50%;"></span>
                            <h4
                                style="font-size: 0.75rem; font-weight: 700; color: #64748b; margin: 0; letter-spacing: 1px;">
                                PDF MATERIAL</h4>
                        </div>
                        <p
                            style="font-weight: 800; font-size: 1.1rem; color: var(--primary-dark); margin-bottom: 16px; line-height: 1.4;">
                            Modern History Short Notes</p>
                        <a href="#"
                            style="display: inline-flex; align-items: center; gap: 6px; font-size: 0.9rem; color: var(--primary-green); font-weight: 700; text-decoration: none;">
                            Open Now <span style="font-size: 1.2rem;">→</span>
                        </a>
                    </div>
                    <div class="info-card"
                        style="margin: 0; padding: 24px; background: white; border: 1px solid #e2e8f0; border-radius: 16px; transition: transform 0.3s, box-shadow 0.3s;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                            <span
                                style="display: inline-block; width: 8px; height: 8px; background: #8b5cf6; border-radius: 50%;"></span>
                            <h4
                                style="font-size: 0.75rem; font-weight: 700; color: #64748b; margin: 0; letter-spacing: 1px;">
                                QUESTION</h4>
                        </div>
                        <p
                            style="font-weight: 800; font-size: 1.1rem; color: var(--primary-dark); margin-bottom: 16px; line-height: 1.4;">
                            Article 370 Explanation</p>
                        <a href="#"
                            style="display: inline-flex; align-items: center; gap: 6px; font-size: 0.9rem; color: var(--primary-green); font-weight: 700; text-decoration: none;">
                            Review Info <span style="font-size: 1.2rem;">→</span>
                        </a>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-info">
                    <div class="footer-logo">Gov<span>Learn</span></div>
                    <p class="footer-tagline">Empowering aspirants to achieve their dreams of a government career
                        through quality education.</p>
                </div>
                <div class="footer-links">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="mock-tests.html">Mock Tests</a></li>
                        <li><a href="materials.html">Materials</a></li>
                        <li><a href="videos.html">Videos</a></li>
                    </ul>
                </div>
                <div class="footer-links">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="#">Current Affairs</a></li>
                        <li><a href="#">Syllabus Guide</a></li>
                        <li><a href="#">Exam Notifications</a></li>
                        <li><a href="#">Help Center</a></li>
                    </ul>
                </div>
                <div class="footer-links">
                    <h4>Follow Us</h4>
                    <div class="social-links">
                        <a href="#" class="social-icon">FB</a>
                        <a href="#" class="social-icon">TW</a>
                        <a href="#" class="social-icon">IG</a>
                        <a href="#" class="social-icon">YT</a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2026 Gov Learn. All rights reserved.</p>
                <div class="footer-bottom-links">
                    <a href="#"
                        style="color: rgba(255,255,255,0.5); text-decoration: none; font-size: 0.9rem; margin-left: 20px;">Privacy
                        Policy</a>
                    <a href="#"
                        style="color: rgba(255,255,255,0.5); text-decoration: none; font-size: 0.9rem; margin-left: 20px;">Terms
                        of Service</a>
                </div>
            </div>
        </div>
    </footer>


    <!-- Modals (Re-using system-consistent modal HTML) -->
    <div id="login-modal" class="modal-overlay">
        <div class="modal">
            <button type="button" class="modal-close" onclick="toggleModal('login-modal')">&times;</button>
            <h2 style="margin-bottom: 10px; font-weight:800; color:var(--primary-dark);">Welcome Back</h2>
            <p style="color: var(--text-muted); margin-bottom: 32px;">Please enter your details to sign in.</p>
            <form id="login-form">
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="login-email" placeholder="name@example.com" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="login-password" placeholder="••••••••" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">Sign In</button>
            </form>
            <div class="social-divider">or continue with</div>
            <button type="button" class="google-btn" onclick="googleSignIn()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                Sign in with Google
            </button>
            <p style="margin-top: 32px; text-align: center; font-size: 0.95rem; color: var(--text-muted);">
                Don't have an account? <a href="#"
                    style="color: var(--primary-green); font-weight: 700; text-decoration:none;"
                    onclick="toggleModal('login-modal'); toggleModal('signup-modal')">Sign Up</a>
            </p>
        </div>
    </div>

    <div id="signup-modal" class="modal-overlay">
        <div class="modal">
            <button type="button" class="modal-close" onclick="toggleModal('signup-modal')">&times;</button>
            <h2 style="margin-bottom: 10px; font-weight:800; color:var(--primary-dark);">Create Account</h2>
            <p style="color: var(--text-muted); margin-bottom: 32px;">Join thousands of successful aspirants today.</p>
            <form id="signup-form">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="signup-name" placeholder="John Doe" required>
                </div>
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="signup-email" placeholder="name@example.com" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="signup-password" placeholder="••••••••" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">Create Account</button>
            </form>
            <div class="social-divider">or continue with</div>
            <button type="button" class="google-btn" onclick="googleSignIn()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                Sign up with Google
            </button>
            <p style="margin-top: 32px; text-align: center; font-size: 0.95rem; color: var(--text-muted);">
                Already have an account? <a href="#"
                    style="color: var(--primary-green); font-weight: 700; text-decoration:none;"
                    onclick="toggleModal('signup-modal'); toggleModal('login-modal')">Sign In</a>
            </p>
        </div>
    </div>

    <div id="edit-modal" class="modal-overlay">
        <div class="modal">
            <button type="button" class="modal-close" onclick="toggleModal('edit-modal')">&times;</button>
            <h2 style="margin-bottom: 10px; font-weight:800; color:var(--primary-dark);">Edit Profile</h2>
            <p style="color: var(--text-muted); margin-bottom: 32px;">Update your personal information.</p>
            <form id="edit-profile-form">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="edit-name" placeholder="John Doe" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">Save Changes</button>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script src="../js/firebase-config.js"></script>
    <script src="../js/main.js"></script>
    <script>
        console.log("Profile script initialized...");
        auth.onAuthStateChanged(async (user) => {
            console.log("Auth state changed, user:", user ? user.email : "none");
            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            // 1. Immediate UI update from Auth object (Fallback)
            const name = user.displayName || 'Learner';
            const email = user.email || 'No email';

            if (document.getElementById('user-name')) document.getElementById('user-name').textContent = name;
            if (document.getElementById('user-email')) document.getElementById('user-email').textContent = email;
            if (document.getElementById('user-avatar')) document.getElementById('user-avatar').textContent = name[0].toUpperCase();
            if (document.getElementById('edit-name')) document.getElementById('edit-name').value = name;

            const planBadge = document.getElementById('user-plan-badge');
            if (planBadge) {
                planBadge.textContent = 'Free Plan';
                planBadge.className = 'badge-large badge-free';
            }

            // 2. Attempt to fetch extended data from Firestore
            try {
                const userDoc = await db.collection('students').doc(user.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();

                    if (userData.name && document.getElementById('user-name'))
                        document.getElementById('user-name').textContent = userData.name;

                    if (userData.name && document.getElementById('user-avatar'))
                        document.getElementById('user-avatar').textContent = userData.name[0].toUpperCase();

                    if (planBadge) {
                        const plan = userData.plan || 'free';
                        planBadge.textContent = plan.toUpperCase() + ' PLAN';
                        planBadge.className = 'badge-large badge-' + plan;
                    }

                    const enrolled = userData.enrolled ?
                        (userData.enrolled.toDate ? userData.enrolled.toDate().toLocaleDateString() : userData.enrolled) :
                        'Recently Joined';

                    const lastLogin = userData.lastLogin ?
                        (userData.lastLogin.toDate ? userData.lastLogin.toDate().toLocaleDateString() : 'Today') :
                        'Today';

                    if (document.getElementById('user-enrolled')) document.getElementById('user-enrolled').textContent = enrolled;
                    if (document.getElementById('user-last-login')) document.getElementById('user-last-login').textContent = lastLogin;
                    if (document.getElementById('edit-name')) document.getElementById('edit-name').value = userData.name || name;
                }
            } catch (error) {
                console.error("Firestore loading error:", error);
            }
        });

        const editForm = document.getElementById('edit-profile-form');
        if (editForm) {
            editForm.onsubmit = async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                const newName = document.getElementById('edit-name').value;

                if (user) {
                    try {
                        await db.collection('students').doc(user.uid).update({
                            name: newName
                        });
                        await user.updateProfile({ displayName: newName });
                        alert("Profile updated successfully!");
                        toggleModal('edit-modal');
                        location.reload(); // Refresh to show changes
                    } catch (error) {
                        alert("Update failed: " + error.message);
                    }
                }
            };
        }
    </script>
</body>

</html>