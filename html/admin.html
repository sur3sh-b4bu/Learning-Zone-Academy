<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Gov Learn</title>
    <link rel="stylesheet" href="../css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* Premium Design System - Aligned with GovLearn Main Site */
            --primary: #059669;
            --primary-light: #ecfdf5;
            --primary-accent: #10b981;
            --secondary: #0f172a;

            --text-main: #1e293b;
            --text-secondary: #64748b;
            --text-light: #94a3b8;

            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --bg-sidebar: #0f172a;
            --glass-background: rgba(255, 255, 255, 0.8);
            --glass-border: rgba(255, 255, 255, 0.4);

            --border-color: #e2e8f0;

            /* Spacing Grid - Enhanced for Breathability */
            --space-1: 8px;
            --space-2: 16px;
            --space-3: 32px;
            --space-4: 40px;

            /* Premium Radii - Extra Smooth Transitions */
            --radius-sm: 8px;
            --radius-md: 16px;
            --radius-lg: 28px;
            --radius-xl: 40px;

            --sidebar-width: 280px;
            --navbar-height: 64px;

            /* Premium Shadows & 3D */
            --shadow-soft: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 10px 15px -3px rgba(15, 23, 42, 0.08);
            --shadow-lg: 0 20px 25px -5px rgba(15, 23, 42, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-3d: 0 20px 40px -12px rgba(5, 150, 105, 0.2);

            --transition-base: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-smooth: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Base Reset & Premium Typography */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #f1f5f9;
            color: var(--text-main);
            overflow: hidden;
            height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        /* Layout Structure */
        .admin-wrapper {
            display: flex;
            width: 100%;
            height: 100vh;
        }

        /* Sidebar: Dark Premium Glass Style */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-sidebar);
            background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 1000;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 10px 0 30px rgba(0, 0, 0, 0.1);
        }

        .sidebar.collapsed {
            width: 90px;
        }

        .sidebar-header {
            height: var(--navbar-height);
            padding: 0 var(--space-3);
            display: flex;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .logo-box {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--primary-accent));
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            position: relative;
        }

        .logo-box::after {
            content: '';
            position: absolute;
            inset: -4px;
            background: var(--primary-accent);
            filter: blur(8px);
            opacity: 0.3;
            z-index: -1;
        }

        .logo-text {
            font-weight: 800;
            font-size: 1.25rem;
            color: white;
            letter-spacing: -0.5px;
        }

        .sidebar-menu {
            flex: 1;
            padding: var(--space-2);
            overflow-y: auto;
        }

        .menu-label {
            font-size: 11px;
            font-weight: 800;
            color: rgba(255, 255, 255, 0.4);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin: var(--space-2) 0 var(--space-1) 18px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px 18px;
            color: rgba(148, 163, 184, 0.8);
            text-decoration: none;
            border-radius: var(--radius-md);
            font-weight: 500;
            font-size: 14px;
            transition: var(--transition-base);
            margin-bottom: 6px;
            position: relative;
            cursor: pointer;
        }

        .nav-item i {
            width: 24px;
            text-align: center;
            font-size: 1.1rem;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .nav-item:hover {
            color: white;
            background: rgba(255, 255, 255, 0.08);
        }

        .nav-item:hover i {
            transform: scale(1.1);
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.15), transparent);
            color: #10b981;
            font-weight: 700;
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: -16px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 20px;
            background: var(--primary-accent);
            border-radius: 0 4px 4px 0;
            box-shadow: 4px 0 12px rgba(16, 185, 129, 0.4);
        }

        /* Sidebar Toggle & Footer */
        .sidebar-desktop-toggle {
            background: #f8fafc;
            border: 1px solid var(--border-color);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
            transition: var(--transition);
        }

        .sidebar-desktop-toggle:hover {
            background: #f1f5f9;
            color: var(--primary);
            border-color: var(--primary);
        }

        .sidebar-footer {
            margin-top: auto;
            padding: var(--space-2);
            border-top: 1px solid var(--border-color);
        }

        .sidebar.collapsed .sidebar-desktop-toggle i {
            transform: rotate(180deg);
        }

        .logout-link {
            color: #ff4d4d !important;
            font-weight: 700 !important;
        }

        .logout-link:hover {
            background: rgba(239, 68, 68, 0.1) !important;
            color: #ff1a1a !important;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.2);
        }

        @media (max-width: 1024px) {
            .sidebar-desktop-toggle {
                display: none;
            }
        }

        /* Main Content Area */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            background-color: #f1f5f9;
        }

        /* Premium Glassmorphism Utility */
        .glass {
            background: #ffffff;
            border: 1px solid rgba(15, 23, 42, 0.04);
            box-shadow: 0 16px 40px -10px rgba(15, 23, 42, 0.08);
        }

        .hover-3d {
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .hover-3d:hover {
            transform: translateY(-8px) rotateX(1deg) rotateY(-1deg);
            box-shadow: var(--shadow-3d);
        }

        /* Top Navbar: Premium Glass */
        .navbar {
            height: var(--navbar-height);
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-4);
            flex-shrink: 0;
            z-index: 900;
        }

        .navbar-left {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .mobile-toggle {
            display: none;
            font-size: 1.4rem;
            cursor: pointer;
            color: var(--text-secondary);
            background: none;
            border: none;
        }

        .nav-breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .nav-breadcrumb .separator {
            opacity: 0.5;
            margin: 0 4px;
        }

        .nav-breadcrumb .current {
            color: var(--secondary);
            font-weight: 800;
            background: rgba(15, 23, 42, 0.05);
            padding: 4px 12px;
            border-radius: 6px;
        }

        .navbar-right {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        /* Unified Premium Profile Styles */
        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 14px;
            border-radius: var(--radius-xl);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            background: transparent;
            border: 1px solid transparent;
        }

        .user-profile:hover {
            background: white;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--primary-accent));
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 13px;
            border: 2px solid white;
        }

        .profile-dropdown {
            position: absolute;
            top: calc(100% + 12px);
            right: 0;
            width: 220px;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 5000;
            overflow: hidden;
        }

        .profile-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .profile-dropdown a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            font-size: 13.5px;
            color: #475569;
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition-base);
        }

        .profile-dropdown a:hover {
            background: #f1f5f9;
            color: var(--primary);
            padding-left: 20px;
        }

        .dropdown-divider {
            height: 1px;
            background: #f1f5f9;
            margin: 8px 0;
        }

        .nav-icon-btn {
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: var(--transition);
        }

        .nav-icon-btn:hover {
            background: white;
        }

        .notification-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 10px;
            height: 10px;
            background: #ef4444;
            border-radius: 50%;
            border: 2px solid white;
        }

        .dropdown-pane {
            position: absolute;
            top: calc(100% + 12px);
            right: 0;
            width: 320px;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: var(--transition-base);
            z-index: 5000;
        }

        .dropdown-pane.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-pane-header {
            padding: 16px 20px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dropdown-pane-header h4 {
            margin: 0;
            font-size: 1rem;
            font-weight: 800;
            color: var(--primary-dark);
        }

        .dropdown-pane-content {
            max-height: 400px;
            overflow-y: auto;
        }

        .notif-item {
            padding: 16px 20px;
            display: flex;
            gap: 12px;
            border-bottom: 1px solid #f8fafc;
            transition: background 0.2s;
            cursor: pointer;
        }

        .notif-item:hover {
            background: #f8fafc;
        }

        .notif-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .notif-info p {
            margin: 0;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .notif-time {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Content Container System */
        .content-wrapper {
            flex: 1;
            padding: var(--space-4);
            overflow-y: auto;
            background-color: transparent;
        }

        .container-limit {
            max-width: 1380px;
            margin: 0 auto;
            width: 100%;
        }

        /* Page Header Alignment */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
        }

        .page-title-group h1 {
            font-size: 32px;
            font-weight: 800;
            color: var(--secondary);
            letter-spacing: -0.03em;
        }

        .page-title-group p {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Stats Grid System */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }

        .stat-card {
            background: #ffffff;
            padding: 32px;
            border-radius: var(--radius-lg);
            border: 1px solid rgba(15, 23, 42, 0.04);
            box-shadow: 0 16px 40px -8px rgba(15, 23, 42, 0.08);
            /* Stronger shadow for pure white bg */
            display: flex;
            flex-direction: column;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-12px) scale(1.02);
            box-shadow: 0 40px 80px -15px rgba(15, 23, 42, 0.15), 0 0 0 1px rgba(16, 185, 129, 0.1);
            border-color: rgba(255, 255, 255, 1);
        }

        .stat-card .icon-box {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            margin-bottom: 24px;
            transition: var(--transition-base);
        }

        .stat-card .label {
            color: #64748b;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 800;
            color: #1e293b;
            letter-spacing: -1px;
        }

        .stat-card .trend {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 700;
            margin-top: 16px;
            padding: 6px 12px;
            border-radius: 8px;
            width: fit-content;
        }

        .trend.up {
            background: #f0fdf4;
            color: #16a34a;
        }

        .trend.down {
            background: #fef2f2;
            color: #dc2626;
        }

        /* Dashboard Responsive Grids */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1.2fr;
            gap: var(--space-4);
        }

        /* Reusable Glass Cards */
        .glass-card {
            background: #ffffff;
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(15, 23, 42, 0.04);
            box-shadow: 0 20px 50px -10px rgba(15, 23, 42, 0.08);
            margin-bottom: var(--space-4);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
        }

        .glass-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 35px 70px -12px rgba(15, 23, 42, 0.15), 0 0 0 1px rgba(16, 185, 129, 0.1);
        }

        .glass-card::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            padding: 1px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 1), rgba(255, 255, 255, 0.1));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: xor;
            -webkit-mask-composite: destination-out;
            pointer-events: none;
        }

        .section-header h3 {
            font-size: 22px;
            font-weight: 800;
            color: var(--secondary);
            margin-bottom: 6px;
            letter-spacing: -0.5px;
        }

        /* Table Architecture: High-Breathability SaaS Layout */
        .text-center {
            text-align: center !important;
        }

        .user-table-wrapper {
            overflow-x: auto;
            margin: var(--space-2) 0;
            padding: 4px;
        }

        .user-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 16px;
            white-space: nowrap;
        }

        .user-table th {
            background: #f8fafc;
            padding: 18px 28px;
            text-align: left;
            font-size: 11px;
            font-weight: 800;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: none;
        }

        .user-table th:first-child {
            border-radius: 16px 0 0 16px;
        }

        .user-table th:last-child {
            border-radius: 0 16px 16px 0;
        }

        .user-table td {
            padding: 24px 28px;
            background: white;
            border-top: 1px solid #f1f5f9;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
            transition: var(--transition-base);
        }

        .user-table td:first-child {
            border-left: 1px solid #f1f5f9;
            border-top-left-radius: 24px;
            border-bottom-left-radius: 24px;
        }

        .user-table td:last-child {
            border-right: 1px solid #f1f5f9;
            border-top-right-radius: 24px;
            border-bottom-right-radius: 24px;
        }

        .user-table tr {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.01);
        }

        .user-table tr:hover td {
            background: #fdfdfd;
            border-color: #e2e8f0;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.05);
        }

        .table-title-stack {
            display: flex;
            flex-direction: column;
            gap: 4px;
            text-align: left;
        }

        .table-title {
            font-size: 17px;
            font-weight: 700;
            color: #1e293b;
            line-height: 1.3;
        }

        .table-category {
            font-size: 13px;
            font-weight: 600;
            color: #94a3b8;
            letter-spacing: 0.3px;
        }

        .text-center {
            text-align: center !important;
        }

        .table-stat {
            font-size: 14px;
            font-weight: 700;
            color: #1e293b;
            text-align: center;
            background: #f8fafc;
            padding: 4px 10px;
            border-radius: 6px;
            display: inline-block;
        }

        /* Badges: Vibrant & Professional */
        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 28px;
            padding: 0 14px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            white-space: nowrap;
        }

        .badge-success {
            background: #DCFCE7;
            color: #15803D;
        }

        .badge-warning {
            background: #FEF3C7;
            color: #92400E;
        }

        .badge-danger {
            background: #FEE2E2;
            color: #B91C1C;
        }

        .badge-info {
            background: #E0F2FE;
            color: #0369A1;
        }

        /* Settings Components */
        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3) 0;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-row.no-border {
            border-bottom: none;
        }

        .settings-content {
            flex: 1;
            padding-right: var(--space-3);
        }

        .settings-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 4px;
        }

        .settings-desc {
            font-size: 14px;
            color: var(--text-light);
            line-height: 1.5;
        }

        /* Modals & Overlays */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: var(--space-3);
        }

        .modal {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 600px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            animation: modalSlide 0.3s ease-out;
        }

        @keyframes modalSlide {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: var(--space-3);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h2 {
            font-size: 18px;
            font-weight: 700;
        }

        .modal-body {
            padding: var(--space-3);
        }

        .modal-footer {
            padding: var(--space-2) var(--space-3);
            background: #f8fafc;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .form-group {
            margin-bottom: var(--space-3);
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 10px 14px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            font-size: 14px;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }

        .btn-modern {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border-radius: var(--radius-md);
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-accent) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(5, 150, 105, 0.3);
        }

        .btn-secondary {
            background: white;
            box-shadow: inset 0 0 0 1px var(--border-color);
            color: var(--text-secondary);
        }

        /* Action Buttons */
        .action-btn-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .action-btn {
            width: auto;
            min-width: 36px;
            height: 36px;
            padding: 0 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            border: 1px solid #E2E8F0;
            background: #FFFFFF;
            color: #64748B;
            cursor: pointer;
            transition: all 0.2s ease;
            gap: 8px;
        }

        .action-btn i {
            font-size: 14px;
        }

        .action-btn:hover {
            background: #F1F5F9;
            color: #1E293B;
            border-color: #CBD5E1;
            transform: translateY(-1px);
        }

        .action-btn.btn-delete:hover {
            background: #FEF2F2;
            color: #DC2626;
            border-color: #F87171;
        }

        .action-btn.btn-edit:hover {
            background: #F0F9FF;
            color: #0284C7;
            border-color: #7DD3FC;
        }

        .sidebar.collapsed .logo-box,
        .sidebar.collapsed .logo-text,
        .sidebar.collapsed .menu-label,
        .sidebar.collapsed .nav-item span {
            display: none;
        }

        .sidebar.collapsed .nav-item {
            justify-content: center;
            padding: 12px 0;
        }

        .sidebar.collapsed .nav-item i {
            font-size: 1.2rem;
        }

        .sidebar.collapsed .sidebar-header {
            justify-content: center;
            padding: 0;
        }

        .timeline {
            position: relative;
            padding-left: 24px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 7px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #f1f5f9;
        }

        .timeline-item {
            position: relative;
            padding-bottom: var(--space-3);
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -21px;
            top: 4px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary);
            border: 2px solid white;
            box-shadow: 0 0 0 2px #f1f5f9;
        }

        /* Sections Management */
        .admin-section {
            display: none;
            animation: fadeIn 0.2s ease-out;
            background-color: transparent !important;
            border-radius: var(--radius-lg);
            padding: var(--space-4);
        }

        .admin-section.active {
            display: block !important;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse-live {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }

            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        .animate-entry {
            animation: fadeIn 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            opacity: 0;
        }

        .delay-1 {
            animation-delay: 0.1s;
        }

        .delay-2 {
            animation-delay: 0.2s;
        }

        .delay-3 {
            animation-delay: 0.3s;
        }

        .delay-4 {
            animation-delay: 0.4s;
        }

        .stat-card .icon-box i {
            transition: transform 0.3s ease;
        }

        .stat-card:hover .icon-box i {
            animation: float 2s ease-in-out infinite;
        }

        .badge-success.live-pulse {
            animation: pulse-live 2s infinite;
            position: relative;
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, transparent 60%);
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }

        .stat-card:hover::after {
            opacity: 1;
        }

        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -100%;
                transition: left 0.3s ease;
            }

            .sidebar.open {
                left: 0;
            }

            .mobile-toggle {
                display: block;
            }
        }

        /* Profile Dropdown & Settings Page UI */
        .dropdown-header {
            padding: 16px;
            background: #f8fafc;
            border-bottom: 1px solid #f1f5f9;
        }

        .dropdown-header .user-name {
            font-weight: 800;
            color: var(--primary-dark);
            margin-bottom: 4px;
            font-size: 0.95rem;
        }

        .dropdown-header .user-email {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 600;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-row.no-border {
            border-bottom: none;
        }

        .settings-title {
            font-weight: 700;
            color: var(--primary-dark);
            font-size: 1.1rem;
            margin-bottom: 6px;
        }

        .settings-desc {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
        }

        input:checked+.slider {
            background-color: var(--primary-green);
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.4);
        }

        input:checked+.slider:before {
            transform: translateX(22px);
        }

        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        .mobile-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.4rem;
            color: var(--secondary);
            cursor: pointer;
            width: 40px;
            height: 40px;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            transition: background 0.2s;
        }

        .mobile-toggle:hover {
            background: var(--bg-main);
        }

        /* ===== ADMIN RESPONSIVE DESIGN ===== */
        @media (max-width: 1024px) {
            .sidebar {
                width: 80px;
            }

            .sidebar .logo-text,
            .sidebar .menu-label,
            .sidebar .nav-item span {
                display: none;
            }

            .sidebar .nav-item {
                justify-content: center;
                padding: 12px 0;
            }

            .sidebar-header {
                justify-content: center;
                padding: 20px 0;
            }

            .main-content {
                margin-left: 80px;
            }

            .top-nav {
                left: 80px;
            }
        }

        @media (max-width: 768px) {
            .mobile-toggle {
                display: flex !important;
                margin-right: 15px;
            }

            .sidebar {
                transform: translateX(-100%);
                width: 280px;
                z-index: 2000;
                transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            }

            .sidebar.mobile-active {
                transform: translateX(0);
            }

            .sidebar .logo-text,
            .sidebar .menu-label,
            .sidebar .nav-item span {
                display: block;
            }

            .sidebar .nav-item {
                justify-content: flex-start;
                padding: 12px 20px;
            }

            .main-content {
                margin-left: 0;
                padding: 20px;
            }

            .top-nav {
                left: 0;
                padding: 0 15px;
            }

            .nav-breadcrumb,
            .user-info {
                display: none;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .settings-container {
                grid-template-columns: 1fr !important;
            }

            .settings-sidebar {
                position: static !important;
            }
        }
    </style>
</head>

<body>
    <div class="admin-wrapper">
        <!-- Modern Sidebar -->
        <aside class="sidebar" id="admin-sidebar">
            <div class="sidebar-header" style="justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 12px; overflow: hidden;">
                    <div class="logo-box"></div>
                    <span class="logo-text"><span style="color: var(--primary-dark);">Admin</span></span>
                </div>
                <!-- Desktop Sidebar Toggle -->
                <button class="sidebar-desktop-toggle" onclick="toggleDesktopSidebar()" title="Toggle Sidebar Display">
                    <i class="fas fa-indent"></i>
                </button>
            </div>

            <div class="sidebar-menu">
                <p class="menu-label">Analytics</p>
                <a href="#" class="nav-item active" onclick="switchSection('dashboard', this)">
                    <i class="fas fa-home"></i> <span>Dashboard</span>
                </a>

                <p class="menu-label">CMS Management</p>
                <a href="#" class="nav-item" onclick="switchSection('content', this)"><i class="fas fa-layer-group"></i>
                    <span>Broadcast Center</span></a>
                <a href="#" class="nav-item" onclick="switchSection('plans', this)"><i class="fas fa-credit-card"></i>
                    <span>Subscription Hub</span></a>
                <a href="#" class="nav-item" onclick="switchSection('ticker', this)"><i
                        class="fas fa-broadcast-tower"></i>
                    <span>Live Updates</span></a>
                <a href="#" class="nav-item" onclick="switchSection('exams', this)"><i
                        class="fas fa-graduation-cap"></i>
                    <span>Exam Hub</span></a>
                <a href="#" class="nav-item" onclick="switchSection('materials', this)"><i
                        class="fas fa-folder-open"></i>
                    <span>Resources</span></a>
                <a href="#" class="nav-item" onclick="switchSection('tests', this)"><i
                        class="fas fa-file-signature"></i>
                    <span>Mock Suite</span></a>
                <a href="#" class="nav-item" onclick="switchSection('videos', this)"><i class="fas fa-play-circle"></i>
                    <span>Video Master</span></a>
                <a href="#" class="nav-item" onclick="switchSection('pyq', this)"><i class="fas fa-history"></i>
                    <span>Results & PYQ</span></a>

                <p class="menu-label">Administration</p>
                <a href="#" class="nav-item" onclick="switchSection('students', this)"><i class="fas fa-users-cog"></i>
                    <span>Learners</span></a>
                <a href="#" class="nav-item" onclick="switchSection('payments', this)"><i class="fas fa-wallet"></i>
                    <span>Revenue</span></a>
                <a href="#" class="nav-item" onclick="switchSection('settings', this)"><i class="fas fa-cog"></i>
                    <span>Settings</span></a>

                <div class="sidebar-footer">
                    <a href="#" class="nav-item logout-link" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
                    </a>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-area">
            <!-- Top Navbar -->
            <header class="navbar">
                <div class="navbar-left">
                    <button class="mobile-toggle" onclick="toggleMobileSidebar()"><i class="fas fa-bars"></i></button>
                    <div class="nav-breadcrumb">
                        <span>Admin</span>
                        <span class="separator"><i class="fas fa-chevron-right" style="font-size: 0.7rem;"></i></span>
                        <span class="current" id="breadcrumb-section">Dashboard</span>
                    </div>
                </div>

                <div class="navbar-right">
                    <div class="nav-icon-btn" onclick="toggleNotifDropdown(event)">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge"></span>
                        <div class="dropdown-pane" id="notif-dropdown">
                            <div class="dropdown-pane-header">
                                <h4>Notifications</h4>
                                <span
                                    style="font-size: 0.75rem; color: var(--primary); font-weight: 700; cursor: pointer;">Clear
                                    All</span>
                            </div>
                            <div class="dropdown-pane-content">
                                <div class="notif-item">
                                    <div class="notif-icon"
                                        style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                                        <i class="fas fa-user-check"></i>
                                    </div>
                                    <div class="notif-info">
                                        <p><b>New Enrollment:</b> Suresh Babu joined SSC CGL Course.</p>
                                        <div class="notif-time">2 mins ago</div>
                                    </div>
                                </div>
                                <div class="notif-item">
                                    <div class="notif-icon"
                                        style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                                        <i class="fas fa-info-circle"></i>
                                    </div>
                                    <div class="notif-info">
                                        <p><b>System Update:</b> Maintenance scheduled for tonight.</p>
                                        <div class="notif-time">1 hour ago</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="user-profile" id="user-profile-menu" onclick="toggleProfileDropdown(event)">
                        <div class="user-info" style="text-align: right;">
                            <div class="name" style="font-size: 0.85rem; font-weight: 700;">Admin Panel</div>
                            <div style="font-size: 0.65rem; color: var(--text-muted); font-weight: 600;">Super Admin
                            </div>
                        </div>
                        <div class="user-avatar">AD</div>

                        <!-- Premium Profile Dropdown -->
                        <div class="profile-dropdown" id="profile-dropdown">
                            <div class="dropdown-header">
                                <p class="user-name">Super Admin</p>
                                <p class="user-email">admin@gmail.com</p>
                            </div>
                            <a href="#" onclick="switchSection('settings', null); return false;"><i
                                    class="fas fa-user-circle"></i>
                                My Profile</a>
                            <a href="#" onclick="switchSection('settings', null); return false;"><i
                                    class="fas fa-cog"></i>
                                Account Settings</a>
                            <div class="dropdown-divider"></div>
                            <a href="#" onclick="logout(); return false;" class="logout-link"><i
                                    class="fas fa-sign-out-alt"></i> Sign Out</a>
                        </div>
                    </div>
                </div>
            </header>

            <div class="content-wrapper" id="admin-main-scroll">
                <div class="container-limit">
                    <!-- Page Header System -->
                    <div class="page-header" id="admin-header-actions">
                        <div class="page-title-group">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <h1 id="admin-welcome-msg" class="animate-entry">Dashboard</h1>
                                <span class="badge badge-success live-pulse animate-entry delay-1"
                                    style="font-size: 10px; height: 20px; text-shadow: 0 0 10px rgba(16, 185, 129, 0.5);">PRODUCTION</span>
                            </div>
                            <p id="admin-current-date">System Overview & Analytics</p>
                        </div>
                        <div class="header-actions-group" style="display: flex; gap: 12px;">
                            <button id="btn-add-alert" class="btn-modern btn-primary" style="display:none;"
                                onclick="window.addAlert()">Add Alert</button>
                            <button id="btn-add-exam" class="btn-modern btn-primary" style="display:none;"
                                onclick="window.showAddSubjectModal()">Add Exam</button>
                            <button id="btn-add-material" class="btn-modern btn-primary" style="display:none;"
                                onclick="window.toggleMaterialModal(true)">Add Material</button>
                            <button id="btn-add-video" class="btn-modern btn-primary" style="display:none;"
                                onclick="window.toggleVideoModal(true)">Add Video</button>
                            <button id="btn-add-test" class="btn-modern btn-primary" style="display:none;"
                                onclick="window.toggleTestModal(true)">Create Test</button>
                            <button id="btn-add-pyq" class="btn-modern btn-primary" style="display:none;"
                                onclick="window.togglePYQModal(true)">Upload PYQ</button>
                        </div>
                    </div>




                    <!-- Dashboard Section -->
                    <section id="section-dashboard" class="admin-section active" style="background-color: #eaefeb;">
                        <!-- Stats Overview -->
                        <div class="stats-grid">
                            <div class="stat-card animate-entry delay-1">
                                <div class="icon-box" style="background: #f0fdf4; color: #10b981;"><i
                                        class="fas fa-users"></i></div>
                                <div class="label">Total Learners</div>
                                <div class="value" id="stat-students">0</div>
                                <div class="trend up"><i class="fas fa-arrow-up"></i> 12.5%</div>
                            </div>
                            <div class="stat-card animate-entry delay-2">
                                <div class="icon-box" style="background: #eff6ff; color: #3b82f6;"><i
                                        class="fas fa-book-open"></i></div>
                                <div class="label">Course Units</div>
                                <div class="value" id="stat-subjects">0</div>
                                <div class="trend up"><i class="fas fa-plus"></i> 4 active</div>
                            </div>
                            <div class="stat-card animate-entry delay-3">
                                <div class="icon-box" style="background: #fff7ed; color: #f97316;"><i
                                        class="fas fa-video"></i></div>
                                <div class="label">Digital Assets</div>
                                <div class="value" id="stat-assets">0</div>
                                <div class="trend up">99.9% Uptime</div>
                            </div>
                            <div class="stat-card animate-entry delay-4">
                                <div class="icon-box" style="background: #fdf2f8; color: #db2777;"><i
                                        class="fas fa-microchip"></i></div>
                                <div class="label">Server Load</div>
                                <div class="value">Optimal</div>
                                <div class="trend up" style="background: #f0fdf4; color: #16a34a;"><i
                                        class="fas fa-check-circle"></i> Healthy</div>
                            </div>
                        </div>

                        <div class="dashboard-grid">
                            <!-- Activity Feed -->
                            <div class="glass-card animate-entry delay-3">
                                <div class="section-header">
                                    <div>
                                        <h3>Operational Log</h3>
                                        <p>System-wide actions and updates</p>
                                    </div>
                                    <div class="badge badge-success live-pulse">Live Sync</div>
                                </div>
                                <div class="timeline" id="dashboard-timeline">
                                    <div style="padding: 40px; text-align: center; color: var(--text-light);">
                                        <i class="fas fa-spinner fa-spin"
                                            style="font-size: 1.5rem; margin-bottom: 12px;"></i>
                                        <p>Connecting to secure stream...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Hub Quick Actions -->
                            <div class="action-grid animate-entry delay-4">
                                <div class="glass-card" style="margin-bottom: 0;">
                                    <h3 style="font-size: 1.1rem; margin-bottom: 20px;">Deployment Tools</h3>
                                    <div style="display: flex; flex-direction: column; gap: 12px;">
                                        <button class="quick-action-btn" onclick="showAddSubjectModal()"
                                            style="display: flex; align-items: center; gap: 16px; padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; background: #f8fafc; text-align: left; cursor: pointer; transition: all 0.2s ease;">
                                            <div class="icon"
                                                style="background: #f0fdf4; color: #166534; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px;">
                                                <i class="fas fa-layer-group"></i>
                                            </div>
                                            <div class="text">
                                                <div class="title"
                                                    style="font-weight: 700; color: #1e293b; font-size: 0.95rem;">Exam
                                                    Architecture</div>
                                                <div class="desc" style="font-size: 0.8rem; color: #64748b;">Define new
                                                    categories and subjects</div>
                                            </div>
                                        </button>
                                        <button class="quick-action-btn" onclick="toggleMaterialModal(true)"
                                            style="display: flex; align-items: center; gap: 16px; padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; background: #f8fafc; text-align: left; cursor: pointer; transition: all 0.2s ease;">
                                            <div class="icon"
                                                style="background: #eff6ff; color: #1e40af; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px;">
                                                <i class="fas fa-file-pdf"></i>
                                            </div>
                                            <div class="text">
                                                <div class="title"
                                                    style="font-weight: 700; color: #1e293b; font-size: 0.95rem;">
                                                    Resource Repository</div>
                                                <div class="desc" style="font-size: 0.8rem; color: #64748b;">Upload PDF
                                                    & document materials</div>
                                            </div>
                                        </button>
                                        <button class="quick-action-btn" onclick="toggleVideoModal(true)"
                                            style="display: flex; align-items: center; gap: 16px; padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; background: #f8fafc; text-align: left; cursor: pointer; transition: all 0.2s ease;">
                                            <div class="icon"
                                                style="background: #fff1f2; color: #9f1239; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 8px;">
                                                <i class="fas fa-play-circle"></i>
                                            </div>
                                            <div class="text">
                                                <div class="title"
                                                    style="font-weight: 700; color: #1e293b; font-size: 0.95rem;">Media
                                                    Master</div>
                                                <div class="desc" style="font-size: 0.8rem; color: #64748b;">Publish
                                                    video lessons & tutorials</div>
                                            </div>
                                        </button>
                                    </div>
                                </div>

                                <div class="stat-card"
                                    style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: white; border: none; margin-top: 24px; text-align: center; justify-content: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);">
                                    <h3 style="font-size: 1.1rem; color: #94a3b8; margin-bottom: 12px;">System Insight
                                    </h3>
                                    <p style="font-size: 0.85rem; color: #94a3b8; line-height: 1.6;">Use the
                                        <strong style="color: #fff;">Learners</strong> panel to audit subscription
                                        lifecycle and manually
                                        override access tiers for scholarship winners.
                                    </p>
                                    <button class="btn-modern btn-modern-primary"
                                        style="width: 100%; margin-top: 20px; font-size: 0.85rem;"
                                        onclick="switchSection('students', this)">Audit Students</button>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Payments Section -->
                    <section id="section-payments" class="admin-section">
                        <div class="glass-card glass">
                            <div class="section-header">
                                <div class="section-header-content">
                                    <h3>Revenue Streams</h3>
                                    <p>Transaction ledger for all subscription enrollments.</p>
                                </div>
                                <button class="btn-modern btn-modern-secondary"
                                    style="font-size: 0.8rem; padding: 8px 16px;">
                                    Export Ledger
                                </button>
                            </div>
                            <div class="user-table-wrapper">
                                <table class="user-table">
                                    <thead>
                                        <tr>
                                            <th>Transaction ID</th>
                                            <th>Student</th>
                                            <th>Amount</th>
                                            <th>Date</th>
                                            <th style="text-align: right;">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="admin-payments-list">
                                        <!-- Syncing rows -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <!-- Revenue Section -->
                    <section id="section-payments" class="admin-section">
                        <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                            <div class="stat-card">
                                <div class="label">Total Revenue</div>
                                <div class="value">0.00</div>
                                <div class="trend up">Lifetime</div>
                            </div>
                            <div class="stat-card">
                                <div class="label">Monthly recurring</div>
                                <div class="value">0.00</div>
                                <div class="trend up">+0%</div>
                            </div>
                            <div class="stat-card">
                                <div class="label">Active Subs</div>
                                <div class="value">0</div>
                                <div class="trend up">Learners</div>
                            </div>
                        </div>
                        <div class="glass-card">
                            <div class="section-header"
                                style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h3>Transaction History</h3>
                                    <p>Recent payments and subscription renewals</p>
                                </div>
                                <button class="btn-modern btn-secondary" style="padding: 8px 16px; font-size: 13px;">
                                    <i class="fas fa-file-export" style="margin-right: 8px;"></i> Export Ledger
                                </button>
                            </div>
                            <div class="user-table-wrapper">
                                <table class="user-table">
                                    <thead>
                                        <tr>
                                            <th>Learner</th>
                                            <th>Plan</th>
                                            <th>Amount</th>
                                            <th>Date</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="revenue-table-body">
                                        <tr>
                                            <td colspan="5"
                                                style="text-align: center; padding: 40px; color: var(--text-muted);">
                                                No active revenue streams detected.
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <!-- Settings Section -->
                    <section id="section-settings" class="admin-section">
                        <div class="grid-2" style="grid-template-columns: 350px 1fr; gap: 32px; display: grid;">
                            <!-- Profile Sidebar -->
                            <div class="glass-card" style="text-align: center; padding: 40px 24px;">
                                <div class="user-avatar"
                                    style="width: 100px; height: 100px; font-size: 2.5rem; margin: 0 auto 24px;">AD
                                </div>
                                <h2 style="font-weight: 900; color: var(--primary-dark); margin-bottom: 4px;">Super
                                    Admin</h2>
                                <p style="color: var(--text-muted); font-weight: 600; margin-bottom: 24px;">
                                    admin@gmail.com</p>

                                <div style="display: flex; flex-direction: column; gap: 12px; text-align: left;">
                                    <div
                                        style="padding: 16px; background: #f8fafc; border-radius: 16px; display: flex; align-items: center; gap: 12px;">
                                        <i class="fas fa-shield-alt" style="color: var(--primary);"></i>
                                        <div>
                                            <div style="font-size: 0.75rem; color: var(--text-muted);">Access Level
                                            </div>
                                            <div
                                                style="font-size: 0.9rem; font-weight: 700; color: var(--primary-dark);">
                                                Ultimate Access</div>
                                        </div>
                                    </div>
                                    <div
                                        style="padding: 16px; background: #f8fafc; border-radius: 16px; display: flex; align-items: center; gap: 12px;">
                                        <i class="fas fa-clock" style="color: var(--accent-orange);"></i>
                                        <div>
                                            <div style="font-size: 0.75rem; color: var(--text-muted);">Last Login</div>
                                            <div
                                                style="font-size: 0.9rem; font-weight: 700; color: var(--primary-dark);">
                                                Today, 10:45 AM</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Settings Main -->
                            <div style="display: flex; flex-direction: column; gap: 32px;">
                                <div class="glass-card" style="padding: 32px;">
                                    <h3
                                        style="font-weight: 900; color: var(--primary-dark); margin-bottom: 24px; display: flex; align-items: center; gap: 12px;">
                                        <i class="fas fa-sliders-h" style="color: var(--primary);"></i> System Controls
                                    </h3>
                                    <div class="settings-row">
                                        <div class="settings-content">
                                            <h4 class="settings-title">Maintenance Mode</h4>
                                            <p class="settings-desc">Temporarily disable learner logins and show a
                                                maintenance page.</p>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox"
                                                onchange="updateGlobalSetting('maintenanceMode', this.checked)"
                                                id="setting-maintenance">
                                            <span class="slider round"></span>
                                        </label>
                                    </div>
                                    <div class="settings-row">
                                        <div class="settings-content">
                                            <h4 class="settings-title">New Registrations</h4>
                                            <p class="settings-desc">Allow new students to sign up for the platform.</p>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox"
                                                onchange="updateGlobalSetting('allowRegistrations', this.checked)"
                                                id="setting-registration">
                                            <span class="slider round"></span>
                                        </label>
                                    </div>
                                    <div class="settings-row no-border">
                                        <div class="settings-content">
                                            <h4 class="settings-title">Email Notifications</h4>
                                            <p class="settings-desc">Receive system-wide alerts and student activity
                                                reports.</p>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox"
                                                onchange="showToast('Email notifications toggled', 'success')"
                                                id="setting-emails">
                                            <span class="slider round"></span>
                                        </label>
                                    </div>
                                </div>

                                <div class="glass-card" style="padding: 32px;">
                                    <h3
                                        style="font-weight: 900; color: var(--primary-dark); margin-bottom: 24px; display: flex; align-items: center; gap: 12px;">
                                        <i class="fas fa-database" style="color: var(--accent-purple);"></i>
                                        Infrastructure
                                    </h3>
                                    <h4
                                        style="font-weight: 800; color: var(--primary-dark); font-size: 1.1rem; margin-bottom: 8px;">
                                        Seed Sample Data</h4>
                                    <p style="color: var(--text-muted); font-size: 0.95rem; margin-bottom: 24px;">Upload
                                        all mock/demo data to Firebase collections. This will populate Exam Categories,
                                        Courses, and more.</p>
                                    <div id="seed-progress" style="display: none; margin-bottom: 16px;">
                                        <div
                                            style="background: #f1f5f9; border-radius: 99px; height: 10px; overflow: hidden;">
                                            <div id="seed-progress-bar"
                                                style="background: linear-gradient(90deg, var(--primary-green), var(--accent-teal)); height: 100%; width: 0%; transition: width 0.4s; border-radius: 99px;">
                                            </div>
                                        </div>
                                        <p id="seed-status"
                                            style="color: var(--text-muted); font-size: 0.85rem; margin-top: 10px; font-weight: 600;">
                                            Starting...</p>
                                    </div>
                                    <button class="btn-modern btn-modern-primary" onclick="seedMockDataToFirebase()"
                                        id="seed-btn">
                                        <i class="fas fa-cloud-upload-alt" style="margin-right: 8px;"></i> Upload Mock
                                        Data to Firebase
                                    </button>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Ticker Section -->
                    <section id="section-ticker" class="admin-section">
                        <!-- Add Ticker Item Form -->
                        <div class="glass-card">
                            <div class="section-header">
                                <div class="section-header-content">
                                    <h3>Real-time Broadcasts</h3>
                                    <p>Global notifications that scroll across all learner screens.</p>
                                </div>
                                <button type="submit" form="add-ticker-form" class="btn-modern btn-modern-primary">
                                    <i class="fas fa-satellite-dish" style="margin-right: 8px;"></i> Broadcast
                                </button>
                            </div>
                            <form id="add-ticker-form" class="form-grid" style="align-items: end; gap: 16px;">
                                <div class="form-group">
                                    <label>Pulse Tag</label>
                                    <select id="ticker-badge" class="form-control">
                                        <option value="NEW">NEW</option>
                                        <option value="ALERT">ALERT</option>
                                        <option value="UPDATE">UPDATE</option>
                                        <option value="OFFER">OFFER</option>
                                        <option value="EXAM">EXAM</option>
                                        <option value="RESULT">RESULT</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Notification Message</label>
                                    <input type="text" id="ticker-text" placeholder="Type breaking news here..."
                                        required class="form-control">
                                </div>
                            </form>
                        </div>

                        <div class="user-table-wrapper">
                            <table class="user-table">
                                <thead>
                                    <tr>
                                        <th class="text-center">Severity</th>
                                        <th>Notification Message</th>
                                        <th class="text-center">Broadcast Time</th>
                                        <th style="text-align: right;">Manage</th>
                                    </tr>
                                </thead>
                                <tbody id="ticker-table-body">
                                    <!-- Injected by JS -->
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <!-- Plans Section -->
                    <section id="section-plans" class="admin-section">
                        <!-- Plan Form -->
                        <div class="glass-card">
                            <div class="section-header" style="margin-bottom: 24px;">
                                <div class="section-header-content">
                                    <h3 id="plan-form-title">Add New Subscription Plan</h3>
                                    <p>Design pricing tiers, access controls, and feature sets.</p>
                                </div>
                                <div style="display: flex; gap: 12px;">
                                    <button type="button" class="btn-modern" onclick="resetPlanForm()"
                                        style="background: #e2e8f0; color: #475569;">Cancel</button>
                                    <button type="submit" form="plan-form" class="btn-modern btn-modern-primary">
                                        <i class="fas fa-save" style="margin-right: 8px;"></i> Save Plan
                                    </button>
                                </div>
                            </div>
                            <form id="plan-form">
                                <input type="hidden" id="plan-id">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>Plan Name</label>
                                        <input type="text" id="plan-name" placeholder="Pro Plan" required
                                            class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label>Price ()</label>
                                        <input type="text" id="plan-price" placeholder="1,499" required
                                            class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label>Period (e.g. /life)</label>
                                        <input type="text" id="plan-period" placeholder="/life" required
                                            class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label>Button Label</label>
                                        <input type="text" id="plan-btn-text" placeholder="Get Pro" required
                                            class="form-control">
                                    </div>
                                </div>
                                <div class="form-group" style="margin-bottom: 20px;">
                                    <label>Features (Comma separated)</label>
                                    <textarea id="plan-features" placeholder="Feature 1, Feature 2, Feature 3" required
                                        class="form-control" style="height: 80px;"></textarea>
                                </div>
                                <div class="form-grid"
                                    style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                                    <div class="form-group"
                                        style="flex-direction: row; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="plan-popular"
                                            style="width: 18px; height: 18px; cursor: pointer;">
                                        <label for="plan-popular" style="margin: 0; cursor: pointer;">Mark as
                                            Popular</label>
                                    </div>
                                    <div class="form-group">
                                        <label>Badge Text</label>
                                        <input type="text" id="plan-badge" placeholder="MOST VALUE"
                                            class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label>Accent Color</label>
                                        <input type="color" id="plan-color" value="#059669" class="form-control"
                                            style="padding: 4px; height: 48px; cursor: pointer;">
                                    </div>
                                </div>
                            </form>
                        </div>

                        <div class="user-table-wrapper">
                            <table class="user-table">
                                <thead>
                                    <tr>
                                        <th>Plan Details</th>
                                        <th>Pricing</th>
                                        <th style="min-width: 200px;">Key Features</th>
                                        <th class="text-center">Visibility</th>
                                        <th class="text-center">Manage</th>
                                    </tr>
                                </thead>
                                <tbody id="plans-table-body">
                                    <tr>
                                        <td colspan="5"
                                            style="text-align: center; padding: 40px; color: var(--text-muted);">
                                            Fetching subscriber plans...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <!-- App Content Section -->
                    <section id="section-content" class="admin-section">
                        <div class="glass-card">
                            <div class="section-header">
                                <div class="section-header-content">
                                    <h3>Platform Announcements</h3>
                                    <p>Configure the main hub countdown and dynamic homepage banners.</p>
                                </div>
                                <button type="submit" form="hero-config-form" class="btn-modern btn-modern-primary">
                                    <i class="fas fa-save" style="margin-right: 8px;"></i> Save Hub Config
                                </button>
                            </div>

                            <form id="hero-config-form" onsubmit="event.preventDefault(); window.saveHeroSettings();">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>Banner Notification Text</label>
                                        <input type="text" id="hero-notif-input"
                                            placeholder="e.g SSC CGL 2026 Exam Starts in:" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label>Countdown Target Time</label>
                                        <input type="datetime-local" id="hero-countdown-input" class="form-control">
                                    </div>
                                </div>
                            </form>

                            <div
                                style="margin-top: 24px; padding: 16px; background: #fffbeb; border: 1px solid #fef3c7; border-radius: 12px; display: flex; gap: 12px; align-items: flex-start;">
                                <div style="font-size: 1.2rem; color: #92400e;"><i
                                        class="fas fa-exclamation-circle"></i>
                                </div>
                                <div>
                                    <p style="margin: 0; font-weight: 700; color: #92400e; font-size: 0.9rem;">
                                        Propogation
                                        Note
                                    </p>
                                    <p style="margin: 4px 0 0 0; color: #b45309; font-size: 0.8rem; line-height: 1.4;">
                                        Changes
                                        made here refresh the learner homepage immediately via the Firebase real-time
                                        engine.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="user-table-wrapper">
                            <table class="user-table">
                                <thead>
                                    <tr>
                                        <th>Deployment History</th>
                                        <th>Status</th>
                                        <th style="text-align: right;">Manage</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-alerts-list">
                                    <!-- Injected rows -->
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <!-- Exams Section -->
                    <section id="section-exams" class="admin-section">
                        <div class="glass-card">
                            <div class="section-header">
                                <div class="section-header-content">
                                    <h3>Curriculum Architecture</h3>
                                    <p>Organize exams, subjects, and their specific testing patterns.</p>
                                </div>
                                <div class="user-table-wrapper">
                                    <table class="user-table">
                                        <thead>
                                            <tr>
                                                <th>Exam Name / Category</th>
                                                <th class="text-center">Syllabus Highlights</th>
                                                <th class="text-center">Active Pattern</th>
                                                <th class="text-center">Manage</th>
                                            </tr>
                                        </thead>
                                        <tbody id="admin-subject-list">
                                            <!-- Injected rows -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                    </section>

                    <!-- Materials Section -->
                    <section id="section-materials" class="admin-section">
                        <div class="glass-card">
                            <div class="section-header">
                                <div class="section-header-content">
                                    <h3>Document Library</h3>
                                    <p>Upload and categorize PDFs, handouts, and daily digests.</p>
                                </div>
                                <div class="user-table-wrapper">
                                    <table class="user-table">
                                        <thead>
                                            <tr>
                                                <th>Resource Title & Subject</th>
                                                <th class="text-center">Asset Type</th>
                                                <th class="text-center">Status</th>
                                                <th class="text-center">Manage</th>
                                            </tr>
                                        </thead>
                                        <tbody id="admin-materials-list">
                                            <!-- Injected rows -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                    </section>

                    <!-- Videos Section -->
                    <section id="section-videos" class="admin-section">
                        <div class="glass-card">
                            <div class="section-header">
                                <div class="section-header-content">
                                    <h3>Academy Stream Controller</h3>
                                    <p>Manage video collections, live sessions, and doubt clearing archives.</p>
                                </div>
                                <div class="user-table-wrapper">
                                    <table class="user-table">
                                        <thead>
                                            <tr>
                                                <th>Course Collection & Category</th>
                                                <th class="text-center">Delivery Style</th>
                                                <th class="text-center">Total Modules</th>
                                                <th class="text-center">Manage</th>
                                            </tr>
                                        </thead>
                                        <tbody id="admin-videos-list">
                                            <!-- Injected rows -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                    </section>

                    <!-- Mock Tests Section -->
                    <section id="section-tests" class="admin-section">
                        <div class="glass-card">
                            <div class="section-header">
                                <div class="section-header-content">
                                    <h3>Examination Suite</h3>
                                    <p>Initialize full-length mocks and topic-wise practice modules.</p>
                                </div>
                                <div class="user-table-wrapper">
                                    <table class="user-table">
                                        <thead>
                                            <tr>
                                                <th>Examination Title</th>
                                                <th class="text-center">Module Classification</th>
                                                <th class="text-center">Time / Questions</th>
                                                <th class="text-center">Manage</th>
                                            </tr>
                                        </thead>
                                        <tbody id="admin-tests-list">
                                            <!-- Injected rows -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                    </section>

                    <!-- Results & PYQ Section -->
                    <section id="section-pyq" class="admin-section">
                        <div class="glass-card">
                            <div class="section-header">
                                <div class="section-header-content">
                                    <h3>Shared Documents & PYQs</h3>
                                    <p>Upload official results and previous year question papers for open access.</p>
                                </div>
                                <div class="user-table-wrapper">
                                    <table class="user-table">
                                        <thead>
                                            <tr>
                                                <th>Document Title</th>
                                                <th class="text-center">Category</th>
                                                <th class="text-center">Manage</th>
                                            </tr>
                                        </thead>
                                        <tbody id="admin-pyq-list">
                                            <!-- Injected rows -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                    </section>

                    <!-- Students Section -->
                    <section id="section-students" class="admin-section">
                        <div class="glass-card">
                            <div class="section-header">
                                <div class="section-header-content">
                                    <h3>Learner Management</h3>
                                    <p>Audit user profiles, enrollment status, and manual tier overrides.</p>
                                </div>
                                <div style="flex: 1; max-width: 360px; position: relative;">
                                    <i class="fas fa-search"
                                        style="position: absolute; left: 18px; top: 14px; color: #94a3b8; font-size: 0.9rem;"></i>
                                    <input type="text" id="student-search-input" onkeyup="filterStudents()"
                                        placeholder="Search by name, email or mobile..."
                                        style="width: 100%; padding: 12px 20px 12px 48px; border-radius: 12px; border: 1px solid #e2e8f0; background: #f8fafc; font-size: 0.9rem;">
                                </div>
                            </div>
                            <div class="user-table-wrapper">
                                <table class="user-table">
                                    <thead>
                                        <tr>
                                            <th class="text-center">Audit</th>
                                            <th>Student Name</th>
                                            <th>Email ID</th>
                                            <th class="text-center">Subscription</th>
                                            <th class="text-center">Manage</th>
                                        </tr>
                                    </thead>
                                    <tbody id="admin-user-list">
                                        <!-- Dynamic Rows -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>
                </div> <!-- container-limit -->
            </div> <!-- content-wrapper -->
        </main>
    </div> <!-- admin-wrapper -->

    <!-- Add Subject Modal -->
    <div id="add-subject-modal" class="modal-overlay" style="display:none;">
        <div class="modal" style="max-width: 550px;">
            <div class="modal-header">
                <h2 id="subject-modal-title" style="margin: 0; color: var(--primary-dark);">Add Exam Category</h2>
            </div>
            <form id="add-subject-form">
                <input type="hidden" id="edit-subject-id">
                <div class="form-grid">
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Exam Name / Title</label>
                        <input type="text" id="new-subject-name" required placeholder="TNPSC Group 4 - 2026"
                            class="form-control">
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Exam Type</label>
                        <select id="new-subject-category" class="form-control">
                            <option>TNPSC</option>
                            <option>RRB</option>
                            <option>SSC</option>
                            <option>BANK</option>
                            <option>UPSC</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Eligibility</label>
                        <input type="text" id="new-subject-eligibility" placeholder="Any Degree" class="form-control">
                    </div>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label>Exam Pattern Summary</label>
                    <input type="text" id="new-subject-pattern" placeholder="MCQ, 200 Questions, 3 Hours"
                        class="form-control">
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label>Syllabus Overview (HTML allowed)</label>
                    <textarea id="new-subject-syllabus" placeholder="Detailed syllabus or important topics..."
                        class="form-control" style="height: 120px;"></textarea>
                </div>
                <input type="hidden" id="new-subject-icon" value="">
                <div class="modal-footer">
                    <button type="button" class="btn-modern btn-modern-secondary"
                        onclick="toggleSubjectModal(false)">Cancel</button>
                    <button type="submit" class="btn-modern btn-modern-primary">Save Category</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Material Modal -->
    <div id="material-modal" class="modal-overlay" style="display:none;">
        <div class="modal" style="max-width: 580px;">
            <div class="modal-header">
                <h2 id="material-modal-title" style="margin: 0; color: var(--primary-dark);">Upload Study Material</h2>
            </div>
            <form id="add-material-form">
                <input type="hidden" id="edit-material-id">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label>Material Title</label>
                    <input type="text" id="material-title" required placeholder="Ancient History - Part 1"
                        class="form-control">
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Linked Subject</label>
                        <select id="material-subject" class="form-control">
                            <option>Tamil</option>
                            <option>English</option>
                            <option>Maths</option>
                            <option>Reasoning</option>
                            <option>Aptitude</option>
                            <option>Polity</option>
                            <option>History</option>
                            <option>Geography</option>
                            <option>Economy</option>
                            <option>Science</option>
                            <option>General Knowledge</option>
                            <option>Current Affairs</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Content Language</label>
                        <select id="material-lang" class="form-control">
                            <option value="both">Both (Bilingual)</option>
                            <option value="tamil">Tamil ONLY</option>
                            <option value="english">English ONLY</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label>Collection Asset Type</label>
                    <select id="material-type" class="form-control">
                        <option value="notes">Subject Notes</option>
                        <option value="daily_ca">Daily Current Affairs</option>
                        <option value="weekly_ca">Weekly Digest</option>
                        <option value="monthly_ca">Monthly Magazine</option>
                        <option value="gk_static">Static General Knowledge</option>
                    </select>
                </div>

                <div class="form-group" style="margin: 24px 0;">
                    <label>Resource Upload (Cloud Storage)</label>
                    <div id="material-dropzone" onclick="document.getElementById('material-file').click()"
                        style="border: 2px dashed #cbd5e1; border-radius: 16px; padding: 32px; text-align: center; cursor: pointer; background: #f8fafc; transition: 0.3s; border-color: var(--primary-green);">
                        <p style="font-weight: 800; color: var(--primary-dark); margin-bottom: 4px;">Click to Select
                            Reference File</p>
                        <p style="color: #94a3b8; font-size: 0.85rem;">PDF, DOC, DOCX prioritized</p>
                        <p id="material-file-name"
                            style="color: var(--primary-green); font-weight: 700; margin-top: 10px; display: none;"></p>
                    </div>
                    <input type="file" id="material-file" accept=".pdf,.doc,.docx" style="display: none;"
                        onchange="handleFileSelect(this, 'material-file-name', 'material-dropzone')">
                    <div id="material-upload-progress" style="display: none; margin-top: 16px;">
                        <div style="background: #e2e8f0; border-radius: 99px; height: 10px; overflow: hidden;">
                            <div id="material-progress-bar"
                                style="background: linear-gradient(90deg, var(--primary-green), var(--accent-teal)); height: 100%; width: 0%; transition: width 0.3s;">
                            </div>
                        </div>
                    </div>
                </div>

                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                    <div style="flex: 1; height: 1px; background: #f1f5f9;"></div>
                    <span style="color: #94a3b8; font-size: 0.75rem; font-weight: 800; letter-spacing: 1px;">EXTERNAL
                        LINK</span>
                    <div style="flex: 1; height: 1px; background: #f1f5f9;"></div>
                </div>

                <div class="form-group">
                    <input type="text" id="material-url" placeholder="https://drive.google.com/..."
                        class="form-control">
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-modern btn-modern-secondary"
                        onclick="toggleMaterialModal(false)">Cancel</button>
                    <button type="submit" class="btn-modern btn-modern-primary">Publish Material</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Video Modal -->
    <div id="video-modal" class="modal-overlay" style="display:none;">
        <div class="modal" style="max-width: 550px;">
            <div class="modal-header">
                <h2 id="video-modal-title" style="margin: 0; color: var(--primary-dark);">Add Video Course</h2>
            </div>
            <form id="add-video-form">
                <input type="hidden" id="edit-video-id">
                <div class="form-group" style="margin-bottom: 16px;">
                    <label>Course Title</label>
                    <input type="text" id="video-title" required placeholder="Fast Track Math Mastery"
                        class="form-control">
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Target Subject</label>
                        <select id="video-subject" class="form-control">
                            <option>Tamil</option>
                            <option>English</option>
                            <option>Maths</option>
                            <option>Aptitude</option>
                            <option>General Knowledge</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Course Stream</label>
                        <select id="video-type" class="form-control">
                            <option value="recorded">Recorded Session</option>
                            <option value="live">Live Class</option>
                            <option value="doubt">Doubt Solving</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" style="margin: 16px 0;">
                    <label>In-depth Description</label>
                    <textarea id="video-desc" required placeholder="Course overview and objectives..."
                        class="form-control" style="height: 100px;"></textarea>
                </div>

                <div class="form-group">
                    <label>Course Syllabus PDF (Ref/Guide)</label>
                    <div id="video-pdf-dropzone" onclick="document.getElementById('video-pdf-file').click()"
                        style="border: 2px dashed #cbd5e1; border-radius: 16px; padding: 24px; text-align: center; cursor: pointer; background: #f8fafc; transition: 0.3s;">
                        <p style="font-weight: 700; color: var(--primary-dark); margin-bottom: 4px;">Select Course
                            Syllabus</p>
                        <p id="video-pdf-file-name"
                            style="color: var(--primary-green); font-weight: 700; margin-top: 8px; display: none;"></p>
                    </div>
                    <input type="file" id="video-pdf-file" accept="application/pdf" style="display: none;"
                        onchange="handleFileSelect(this, 'video-pdf-file-name', 'video-pdf-dropzone')">

                    <div id="video-pdf-progress" style="display: none; margin-top: 16px;">
                        <div style="background: #e2e8f0; border-radius: 99px; height: 8px; overflow: hidden;">
                            <div id="video-pdf-progress-bar"
                                style="background: var(--primary-green); height: 100%; width: 0%; transition: width 0.3s;">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-modern btn-modern-secondary"
                        onclick="toggleVideoModal(false)">Cancel</button>
                    <button type="submit" class="btn-modern btn-modern-primary">Publish Course</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Test Modal -->
    <!-- Create Test Modal -->
    <div id="test-modal" class="modal-overlay" style="display:none;">
        <div class="modal" style="max-width: 550px;">
            <div class="modal-header">
                <h2 id="test-modal-title" style="margin: 0; color: var(--primary-dark);">Create Mock Test</h2>
            </div>
            <form id="add-test-form">
                <input type="hidden" id="edit-test-id">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label>Test Title / Heading</label>
                    <input type="text" id="test-title" required placeholder="General Studies Full Mock 01"
                        class="form-control">
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Exam Stream</label>
                        <select id="test-exam-type" class="form-control">
                            <option>TNPSC</option>
                            <option>RRB</option>
                            <option>SSC</option>
                            <option>BANK</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Expected Questions</label>
                        <input type="number" id="test-questions" placeholder="200" class="form-control">
                    </div>
                </div>
                <div class="form-grid" style="margin-top: 20px;">
                    <div class="form-group">
                        <label>Test Classification</label>
                        <select id="test-category" class="form-control">
                            <option value="sectional">Sectional Practice</option>
                            <option value="full">Full-Length Mock</option>
                            <option value="topic">Topic-wise Quiz</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Duration (Minutes)</label>
                        <input type="number" id="test-duration" placeholder="180" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-modern btn-modern-secondary"
                        onclick="toggleTestModal(false)">Cancel</button>
                    <button type="submit" class="btn-modern btn-modern-primary">Create Exam</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add PYQ Modal -->
    <div id="pyq-modal" class="modal-overlay" style="display:none;">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="pyq-modal-title" style="margin: 0; color: var(--primary-dark);">Add PYQ / Shared Result</h2>
            </div>
            <form id="add-pyq-form">
                <input type="hidden" id="edit-pyq-id">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label>Document Title</label>
                    <input type="text" id="pyq-name" required placeholder="Group 1 Prelims 2024 Question Paper"
                        class="form-control">
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Category Tag</label>
                        <select id="pyq-category" class="form-control">
                            <option>TNPSC</option>
                            <option>RRB</option>
                            <option>SSC</option>
                            <option>Official Results</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label>Direct Download / Resource URL</label>
                    <input type="text" id="pyq-url" placeholder="https://tnpsc.gov.in/pdffile.pdf" required
                        class="form-control">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-modern btn-modern-secondary"
                        onclick="togglePYQModal(false)">Cancel</button>
                    <button type="submit" class="btn-modern btn-modern-primary">Save Document</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Manage Questions Modal -->
    <div id="questions-modal" class="modal-overlay" style="display:none;">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header" style="justify-content: space-between;">
                <h2 id="questions-modal-title" style="margin: 0; color: var(--primary-dark);">Exam Question Bank</h2>
                <button type="button" class="btn-modern btn-modern-secondary" style="padding: 8px 16px;"
                    onclick="toggleQuestionsModal(false)">Close Panel</button>
            </div>

            <div class="form-grid" style="grid-template-columns: 1.2fr 1fr; gap: 32px; align-items: start;">
                <!-- Add Question Form -->
                <div class="glass-card" style="padding: 24px; border: 1px solid #e2e8f0; border-radius: 20px;">
                    <h3
                        style="margin-bottom: 20px; font-size: 1.15rem; color: var(--primary-dark); font-weight: 800; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-plus-circle"
                            style="background: var(--primary-green); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem;"></i>
                        New Question
                    </h3>
                    <form id="add-question-form">
                        <input type="hidden" id="manage-question-test-id">
                        <div class="form-group" style="margin-bottom: 16px;">
                            <label>Question Content</label>
                            <textarea id="question-text" required placeholder="Type the question here..."
                                class="form-control" style="height: 100px;"></textarea>
                        </div>
                        <div class="form-grid" style="gap: 12px;">
                            <div class="form-group">
                                <label>Option A</label>
                                <input type="text" id="question-opt-a" required class="form-control"
                                    placeholder="Answer A">
                            </div>
                            <div class="form-group">
                                <label>Option B</label>
                                <input type="text" id="question-opt-b" required class="form-control"
                                    placeholder="Answer B">
                            </div>
                            <div class="form-group">
                                <label>Option C</label>
                                <input type="text" id="question-opt-c" required class="form-control"
                                    placeholder="Answer C">
                            </div>
                            <div class="form-group">
                                <label>Option D</label>
                                <input type="text" id="question-opt-d" required class="form-control"
                                    placeholder="Answer D">
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 16px;">
                            <label>Mark Correct Key</label>
                            <select id="question-correct" required class="form-control">
                                <option value="A">Option A</option>
                                <option value="B">Option B</option>
                                <option value="C">Option C</option>
                                <option value="D">Option D</option>
                            </select>
                        </div>
                        <button type="submit" class="btn-modern btn-modern-primary"
                            style="width: 100%; margin-top: 24px;">Add to Test</button>
                    </form>
                </div>

                <!-- Existing Questions List -->
                <div>
                    <h3 style="margin-bottom: 20px; font-size: 1.15rem; color: var(--primary-dark); font-weight: 800;">
                        Paper Review</h3>
                    <div id="questions-list-container"
                        style="display: flex; flex-direction: column; gap: 16px; max-height: 600px; overflow-y: auto; padding-right: 8px;">
                        <!-- Injected Questions -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Playlist Modal -->
    <div id="playlist-modal" class="modal-overlay" style="display:none;">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header" style="justify-content: space-between;">
                <h2 id="playlist-modal-title" style="margin: 0; color: var(--primary-dark);">Course Curriculum Designer
                </h2>
                <button type="button" class="btn-modern btn-modern-secondary" style="padding: 8px 16px;"
                    onclick="togglePlaylistModal(false)">Close Panel</button>
            </div>

            <div class="form-grid" style="grid-template-columns: 1.2fr 1fr; gap: 32px; align-items: start;">
                <!-- Add Lesson Form -->
                <div class="glass-card" style="padding: 24px; border: 1px solid #e2e8f0; border-radius: 20px;">
                    <h3 style="margin-bottom: 20px; font-size: 1.15rem; color: var(--primary-dark); font-weight: 800;">
                        Upload New Lesson</h3>
                    <form id="add-lesson-form">
                        <input type="hidden" id="manage-playlist-course-id">
                        <div class="form-group" style="margin-bottom: 16px;">
                            <label>Lesson Title</label>
                            <input type="text" id="lesson-title" required placeholder="Introduction to Number Systems"
                                class="form-control">
                        </div>

                        <div class="form-group" style="margin: 20px 0;">
                            <label>Video Source (Upload or Cloud Link)</label>
                            <div id="lesson-dropzone" onclick="document.getElementById('lesson-file').click()"
                                style="border: 2px dashed var(--primary-blue); border-radius: 16px; padding: 24px; text-align: center; cursor: pointer; background: #eff6ff; transition: 0.3s;">
                                <p style="font-weight: 700; color: var(--primary-dark); margin-bottom: 4px;">Push Video
                                    Fragment</p>
                                <p id="lesson-file-name"
                                    style="color: var(--primary-blue); font-weight: 700; margin-top: 8px; display: none;">
                                </p>
                            </div>
                            <input type="file" id="lesson-file" accept="video/*" style="display: none;"
                                onchange="handleFileSelect(this, 'lesson-file-name', 'lesson-dropzone')">
                            <div id="lesson-upload-progress" style="display: none; margin-top: 12px;">
                                <div style="background: #e2e8f0; border-radius: 99px; height: 8px; overflow: hidden;">
                                    <div id="lesson-progress-bar"
                                        style="background: var(--primary-blue); height: 100%; width: 0%; transition: width 0.3s;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                            <div style="flex: 1; height: 1px; background: #f1f5f9;"></div>
                            <span style="color: #94a3b8; font-size: 0.7rem; font-weight: 800;">REMOTE URL</span>
                            <div style="flex: 1; height: 1px; background: #f1f5f9;"></div>
                        </div>

                        <div class="form-group">
                            <input type="text" id="lesson-url" placeholder="https://vimeo.com/..." class="form-control">
                        </div>

                        <div class="form-group" style="margin: 20px 0;">
                            <label>Lesson Specific Notes</label>
                            <textarea id="lesson-notes" placeholder="Key takeaways from this lecture..."
                                class="form-control" style="height: 80px;"></textarea>
                        </div>

                        <div class="form-group" style="margin-bottom: 24px;">
                            <label>Reference Material (PDF)</label>
                            <div id="lesson-pdf-dropzone" onclick="document.getElementById('lesson-pdf-file').click()"
                                style="border: 1px dashed #cbd5e1; border-radius: 12px; padding: 16px; text-align: center; cursor: pointer; transition: 0.3s;">
                                <p style="color: #64748b; font-size: 0.9rem; font-weight: 600;">Attach Study PDF</p>
                                <p id="lesson-pdf-file-name"
                                    style="color: var(--primary-green); font-weight: 700; margin-top: 4px; display: none;">
                                </p>
                            </div>
                            <input type="file" id="lesson-pdf-file" accept="application/pdf" style="display: none;"
                                onchange="handleFileSelect(this, 'lesson-pdf-file-name', 'lesson-pdf-dropzone')">
                        </div>

                        <button type="submit" id="lesson-submit-btn" class="btn-modern btn-modern-primary"
                            style="width: 100%;">Commit Lesson</button>
                    </form>
                </div>

                <!-- Existing Lessons List -->
                <div>
                    <h3 style="margin-bottom: 20px; font-size: 1.15rem; color: var(--primary-dark); font-weight: 800;">
                        Course Timeline</h3>
                    <div id="playlist-list-container"
                        style="display: flex; flex-direction: column; gap: 16px; max-height: 600px; overflow-y: auto;">
                        <!-- Injected Lessons -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal-overlay" style="display:none; z-index: 3000;">
        <div class="modal" style="max-width: 450px; text-align: center; padding: 48px 40px;">
            <div id="confirm-icon" style="font-size: 4rem; margin-bottom: 24px; color: var(--primary-green);"><i
                    class="fas fa-question-circle"></i></div>
            <h2 id="confirm-title"
                style="margin-bottom: 12px; color: var(--primary-dark); font-weight: 900; font-size: 1.75rem;">Confirm
                Action</h2>
            <p id="confirm-message"
                style="color: var(--text-muted); margin-bottom: 40px; font-size: 1.1rem; line-height: 1.6;"></p>
            <div style="display: flex; gap: 16px;">
                <button id="confirm-cancel" class="btn-modern btn-modern-secondary" style="flex: 1;">Cancel</button>
                <button id="confirm-ok" class="btn-modern btn-modern-primary"
                    style="flex: 1; background: var(--secondary-red);">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <script src="../js/firebase-config.js"></script>
    <script src="../js/mock-data.js"></script>
    <script>
        /**
         * ADMIN PORTAL CORE ENGINE v2.0
         * Robust, Defensive, and Highly Available
         */
        const ADMIN_CONFIG = {
            email: 'admin@gmail.com',
            sections: ['dashboard', 'content', 'plans', 'ticker', 'exams', 'materials', 'tests', 'videos', 'pyq', 'students', 'payments', 'settings'],
            headerButtons: ['btn-add-alert', 'btn-add-exam', 'btn-add-material', 'btn-add-video', 'btn-add-test', 'btn-add-pyq']
        };

        // Helper to safely get elements and log if missing
        const safeGet = (id) => {
            const el = document.getElementById(id);
            if (!el) console.warn(`Element #${id} not found in DOM.`);
            return el;
        };

        // Mobile & Desktop sidebar controllers
        window.toggleMobileSidebar = () => {
            const sidebar = safeGet('admin-sidebar');
            if (sidebar) sidebar.classList.toggle('open');
        };

        window.toggleDesktopSidebar = () => {
            const sidebar = safeGet('admin-sidebar');
            if (sidebar) sidebar.classList.toggle('collapsed');
        };

        const closeMobileSidebar = () => {
            const sidebar = safeGet('admin-sidebar');
            if (sidebar) sidebar.classList.remove('open');
        };


        // 1. Toast & Confirmation System
        window.showToast = (message, type = 'success') => {
            const container = safeGet('toast-container');
            if (!container) return;
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icons = {
                'success': 'fa-check-circle',
                'error': 'fa-exclamation-triangle',
                'info': 'fa-info-circle'
            };
            const iconClass = icons[type] || 'fa-info-circle';
            toast.innerHTML = `
                    <div class="toast-icon"><i class="fas ${iconClass}"></i></div>
                    <div class="toast-message">${message}</div>
                `;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 400);
            }, 4000);
        };

        window.customConfirm = (title, message, isDanger = false) => {
            return new Promise((resolve) => {
                const modal = safeGet('confirm-modal');
                if (!modal) return resolve(confirm(message));

                safeGet('confirm-title').textContent = title;
                safeGet('confirm-message').textContent = message;
                const okBtn = safeGet('confirm-ok');
                okBtn.style.background = isDanger ? 'var(--primary)' : 'var(--primary-green)';

                modal.style.display = 'flex';
                const cleanup = () => {
                    modal.style.display = 'none';
                    safeGet('confirm-cancel').onclick = null;
                    okBtn.onclick = null;
                };
                safeGet('confirm-cancel').onclick = () => { cleanup(); resolve(false); };
                okBtn.onclick = () => { cleanup(); resolve(true); };
            });
        };

        // 2. Navigation & View Controller
        window.switchSection = (sectionId, el) => {
            const bc = document.getElementById('breadcrumb-section');

            // 0. Update sidebar active state
            if (el) {
                document.querySelectorAll('.sidebar .nav-item').forEach(n => n.classList.remove('active'));
                el.classList.add('active');
            }

            // 1. Manage Sections
            ADMIN_CONFIG.sections.forEach(s => {
                const sec = safeGet('section-' + s);
                if (sec) sec.classList.remove('active');
            });
            const targetSection = safeGet('section-' + sectionId);
            if (targetSection) targetSection.classList.add('active');

            // 2. Manage Header Buttons
            ADMIN_CONFIG.headerButtons.forEach(id => {
                const btn = safeGet(id);
                if (btn) btn.style.display = 'none';
            });

            // 3. Update Metadata (Titles/Subtitles)
            const sectionMetadata = {
                'dashboard': { title: 'Dashboard', subtitle: 'System Overview & Analytics' },
                'content': { title: 'Broadcast Center', subtitle: 'Announcements & Global Alerts' },
                'plans': { title: 'Subscription Hub', subtitle: 'Plan Management & Pricing' },
                'ticker': { title: 'Live Updates', subtitle: 'Real-time Pulse Notifications' },
                'exams': { title: 'Exam Architecture', subtitle: 'Curriculum & Stream Management' },
                'materials': { title: 'Resources', subtitle: 'Study Materials & Documents' },
                'tests': { title: 'Mock Suite', subtitle: 'Practice Exams & Testing Patterns' },
                'videos': { title: 'Video Master', subtitle: 'Media Collections & Playlists' },
                'pyq': { title: 'Results & PYQ', subtitle: 'Official Results & Past Papers' },
                'students': { title: 'Learners', subtitle: 'User Audits & Subscription Lifecycle' },
                'payments': { title: 'Revenue', subtitle: 'Transaction Ledger & Enrollments' },
                'settings': { title: 'Settings', subtitle: 'Global Platform Configuration' }
            };

            const meta = sectionMetadata[sectionId] || { title: sectionId, subtitle: '' };
            const msgEl = safeGet('admin-welcome-msg');
            const dateEl = safeGet('admin-current-date');

            if (msgEl) {
                if (sectionId === 'dashboard') {
                    const now = new Date();
                    const hours = now.getHours();
                    let greeting = 'Good Evening';
                    if (hours < 12) greeting = 'Good Morning';
                    else if (hours < 17) greeting = 'Good Afternoon';
                    msgEl.textContent = `${greeting}, Admin!`;
                } else {
                    msgEl.textContent = meta.title;
                }
            }

            if (dateEl) {
                if (sectionId === 'dashboard') {
                    const now = new Date();
                    dateEl.textContent = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                } else {
                    dateEl.textContent = meta.subtitle;
                }
            }

            // 4. Update Header Action Buttons
            const sectionToButtonMap = {
                'content': 'btn-add-alert',
                'exams': 'btn-add-exam',
                'materials': 'btn-add-material',
                'videos': 'btn-add-video',
                'tests': 'btn-add-test',
                'pyq': 'btn-add-pyq'
            };
            const activeBtnId = sectionToButtonMap[sectionId];
            if (activeBtnId) {
                const btn = safeGet(activeBtnId);
                if (btn) btn.style.display = 'block';
            }

            // 5. Update Breadcrumb
            if (bc) {
                const bcLabel = sectionId === 'dashboard' ? 'Dashboard' : sectionId.charAt(0).toUpperCase() + sectionId.slice(1);
                bc.textContent = bcLabel;
            }

            // 6. Special Initialization for Dashboard
            if (sectionId === 'dashboard') {
                if (typeof window.refreshDashboard === 'function') window.refreshDashboard();
            }

            // 7. Close mobile sidebar & dropdowns
            closeMobileSidebar();
            const dropdown = document.getElementById('profile-dropdown');
            if (dropdown) dropdown.classList.remove('show');
        };

        // 3. Modal & Dropdown Controllers
        window.toggleProfileDropdown = (e) => {
            e.stopPropagation();
            document.getElementById('notif-dropdown')?.classList.remove('show');
            const dropdown = document.getElementById('profile-dropdown');
            if (dropdown) dropdown.classList.toggle('show');
        };

        window.toggleNotifDropdown = (e) => {
            e.stopPropagation();
            document.getElementById('profile-dropdown')?.classList.remove('show');
            const dropdown = document.getElementById('notif-dropdown');
            if (dropdown) dropdown.classList.toggle('show');
        };

        document.addEventListener('click', () => {
            document.getElementById('profile-dropdown')?.classList.remove('show');
            document.getElementById('notif-dropdown')?.classList.remove('show');
        });

        window.toggleModal = (modalId, show) => {
            const modal = safeGet(modalId);
            if (modal) modal.style.display = show ? 'flex' : 'none';
            if (show) document.body.style.overflow = 'hidden';
            else document.body.style.overflow = 'auto';
        };

        // Convenience wrappers for buttons
        window.showAddSubjectModal = () => {
            const form = safeGet('add-subject-form');
            if (form) form.reset();
            const idInput = safeGet('edit-subject-id');
            if (idInput) idInput.value = '';
            const titleEl = safeGet('subject-modal-title');
            if (titleEl) titleEl.textContent = 'Add New Subject';
            toggleModal('add-subject-modal', true);
        };
        window.toggleSubjectModal = (s) => toggleModal('add-subject-modal', s);
        window.toggleMaterialModal = (s) => toggleModal('material-modal', s);
        window.toggleVideoModal = (s) => toggleModal('video-modal', s);
        window.toggleTestModal = (s) => toggleModal('test-modal', s);
        window.togglePYQModal = (s) => toggleModal('pyq-modal', s);
        window.toggleQuestionsModal = (s) => toggleModal('questions-modal', s);

        // 3b. Ticker / Live Updates CRUD
        window.fetchTicker = async () => {
            const tbody = safeGet('ticker-table-body');
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 30px; color: var(--text-muted);">Loading...</td></tr>';
            try {
                const snap = await db.collection('ticker').orderBy('createdAt', 'desc').get();
                if (snap.empty) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 40px; color: var(--text-muted);">No ticker items yet. Add one above!</td></tr>';
                    return;
                }
                snap.forEach(doc => {
                    const d = doc.data();
                    const date = d.createdAt ? new Date(d.createdAt.seconds * 1000).toLocaleDateString() : 'N/A';
                    const badgeColors = { NEW: '#10b981', ALERT: '#ef4444', UPDATE: '#3b82f6', OFFER: '#f59e0b', EXAM: '#8b5cf6', RESULT: '#06b6d4' };
                    const color = badgeColors[d.badge] || '#64748b';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                            <td class="text-center"><span class="badge" style="background: ${color}15; color: ${color}; border: 1px solid ${color}30; font-weight: 700;">${d.badge || 'UPDATE'}</span></td>
                            <td style="max-width: 400px; padding: 18px 24px;">
                                <div style="font-weight: 600; color: #1e293b;">${d.text || ''}</div>
                            </td>
                            <td class="text-center" style="color: #64748b; font-size: 13px;">${date}</td>
                            <td class="text-center">
                                <button class="action-btn btn-delete" title="Remove Notification" onclick="deleteTickerItem('${doc.id}')">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error('Fetch ticker error:', err);
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 30px; color: #dc2626;">Error loading ticker: ' + err.message + '</td></tr>';
            }
        };

        window.addTickerItem = async (badge, text) => {
            try {
                await db.collection('ticker').add({
                    badge: badge,
                    text: text,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast('Ticker item added!', 'success');
                fetchTicker();
            } catch (err) {
                console.error('Add ticker error:', err);
                showToast('Error: ' + err.message, 'error');
            }
        };

        window.deleteTickerItem = async (docId) => {
            if (!confirm('Delete this ticker item?')) return;
            try {
                await db.collection('ticker').doc(docId).delete();
                showToast('Ticker item deleted', 'success');
                fetchTicker();
            } catch (err) {
                console.error('Delete ticker error:', err);
                showToast('Error: ' + err.message, 'error');
            }
        };

        // Ticker form handler
        const tickerForm = safeGet('add-ticker-form');
        if (tickerForm) {
            tickerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const badge = safeGet('ticker-badge')?.value || 'UPDATE';
                const text = safeGet('ticker-text')?.value?.trim();
                if (!text) { showToast('Please enter a message', 'error'); return; }
                addTickerItem(badge, text);
                safeGet('ticker-text').value = '';
            });
        }

        window.plansData = []; // Cache for dynamic plan management

        // --- Subscription Plans CRUD ---
        window.fetchPlans = async () => {
            const tbody = safeGet('plans-table-body');
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Loading...</td></tr>';
            try {
                const snapshot = await db.collection('plans').orderBy('price', 'asc').get();
                tbody.innerHTML = '';
                window.plansData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (window.plansData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No plans found.</td></tr>';
                    return;
                }

                window.plansData.forEach(plan => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>
                            <span class="table-title">${plan.name}</span>
                            <span class="table-category">${plan.period} Cycle</span>
                        </td>
                        <td style="font-weight:700; color: #1E293B;">${plan.price}</td>
                        <td style="color:var(--text-muted); font-size: 14px;">${plan.features.join(', ')}</td>
                        <td class="text-center">
                            ${plan.popular ? `<span class="badge badge-success">Popular</span>` : '<span class="badge badge-info">Standard</span>'}
                        </td>
                        <td class="text-center">
                            <div class="action-btn-group" style="justify-content: center;">
                                <button class="action-btn btn-edit" title="Edit Plan" onclick="editPlan('${plan.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn btn-delete" title="Delete Plan" onclick="deletePlan('${plan.id}')">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error('Fetch plans error:', err);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red;">' + err.message + '</td></tr>';
            }
        };

        window.editPlan = async (id) => {
            try {
                const doc = await db.collection('plans').doc(id).get();
                if (doc.exists) {
                    const d = doc.data();
                    safeGet('plan-id').value = id;
                    safeGet('plan-name').value = d.name;
                    safeGet('plan-price').value = d.price;
                    safeGet('plan-period').value = d.period;
                    safeGet('plan-btn-text').value = d.buttonText || '';
                    safeGet('plan-features').value = d.features.join(', ');
                    safeGet('plan-popular').checked = d.popular || false;
                    safeGet('plan-badge').value = d.badge || '';
                    safeGet('plan-color').value = d.color || '#059669';
                    safeGet('plan-form-title').textContent = 'Edit Plan: ' + d.name;
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } catch (err) { showToast('Error fetching plan: ' + err.message, 'error'); }
        };

        window.deletePlan = async (id) => {
            if (!confirm('Are you sure you want to delete this plan?')) return;
            try {
                await db.collection('plans').doc(id).delete();
                showToast('Plan deleted!', 'success');
                fetchPlans();
            } catch (err) { showToast('Error deleting plan: ' + err.message, 'error'); }
        };

        window.resetPlanForm = () => {
            safeGet('plan-form').reset();
            safeGet('plan-id').value = '';
            safeGet('plan-form-title').textContent = 'Add New Plan';
        };

        const planForm = safeGet('plan-form');
        if (planForm) {
            planForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = safeGet('plan-id').value;
                const data = {
                    name: safeGet('plan-name').value,
                    price: safeGet('plan-price').value,
                    period: safeGet('plan-period').value,
                    buttonText: safeGet('plan-btn-text').value,
                    features: safeGet('plan-features').value.split(',').map(f => f.trim()).filter(f => f),
                    popular: safeGet('plan-popular').checked,
                    badge: safeGet('plan-badge').value,
                    color: safeGet('plan-color').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    if (id) {
                        await db.collection('plans').doc(id).update(data);
                        showToast('Plan updated!', 'success');
                    } else {
                        data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        // For the first mock data consistency, use the name as ID if it is a new addition
                        const planId = data.name.toLowerCase().replace(/\s+/g, '-');
                        await db.collection('plans').doc(planId).set(data);
                        showToast('Plan added!', 'success');
                    }
                    resetPlanForm();
                    fetchPlans();
                } catch (err) { showToast('Error saving plan: ' + err.message, 'error'); }
            });
        }

        // 4. Data Operations (Subjects)
        window.fetchSubjects = async () => {
            const list = safeGet('admin-subject-list');
            if (!list) return;
            list.innerHTML = '<tr><td colspan="4" style="text-align:center;">Loading...</td></tr>';
            try {
                const snap = await db.collection('subjects').orderBy('name').get();
                list.innerHTML = '';
                if (snap.empty) {
                    list.innerHTML = '<tr><td colspan="4" style="text-align:center;">No subjects found.</td></tr>';
                    return;
                }
                snap.forEach(doc => {
                    const s = doc.data();
                    const row = document.createElement('tr');
                    const args = `'${doc.id}','${(s.name || '').replace(/'/g, "\\'").replace(/"/g, "&quot;")}','${(s.category === 'undefined' ? 'General' : s.category || 'General').replace(/'/g, "\\'").replace(/"/g, "&quot;")}','${(s.syllabus || '').replace(/'/g, "\\'").replace(/"/g, "&quot;")}','${(s.pattern || '').replace(/'/g, "\\'").replace(/"/g, "&quot;")}','${(s.eligibility || '').replace(/'/g, "\\'").replace(/"/g, "&quot;")}'`;
                    row.innerHTML = `
                                <td>
                                    <div class="table-title-stack">
                                        <span class="table-title">${s.name || 'Untitled Exam'}</span>
                                        <span class="table-category">${s.category === 'undefined' ? 'General' : s.category || 'General'} Stream</span>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <span class="badge badge-info">${(s.category === 'undefined' ? 'General' : s.category || 'General').toUpperCase()}</span>
                                </td>
                                <td class="text-center">
                                    <span class="table-stat">${s.pattern || 'Standard Scoring'}</span>
                                </td>
                                <td class="text-center">
                                    <div class="action-btn-group" style="justify-content: center;">
                                        <button class="action-btn btn-edit" title="Edit Subject" onclick="editSubject(${args})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="action-btn btn-delete" title="Delete Subject" onclick="deleteSubject('${doc.id}')">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </td>
                            `;
                    list.appendChild(row);
                });
                updateStats();
            } catch (e) {
                console.error("Fetch Subjects failed:", e);
                list.innerHTML = '<tr><td colspan="4" style="color:red; text-align:center;">Load Error</td></tr>';
            }
        };

        window.editSubject = (id, name, cat, syllabus, pattern, el) => {
            safeGet('edit-subject-id').value = id;
            safeGet('new-subject-name').value = name;
            safeGet('new-subject-category').value = cat;
            safeGet('new-subject-syllabus').value = syllabus;
            safeGet('new-subject-pattern').value = pattern;
            safeGet('new-subject-eligibility').value = el;
            safeGet('subject-modal-title').textContent = 'Edit Subject';
            toggleModal('add-subject-modal', true);
        };

        window.deleteSubject = async (id) => {
            if (await customConfirm("Delete Subject", "Permanently remove this exam category?", true)) {
                try {
                    await db.collection('subjects').doc(id).delete();
                    showToast("Deleted successfully");
                    fetchSubjects();
                } catch (e) { showToast(e.message, "error"); }
            }
        };

        // 5. Data Operations (Materials, Videos, Tests, PYQ)
        window.deleteItem = async (col, id, cb) => {
            if (await customConfirm("Confirm Delete", "Remove this item permanently?", true)) {
                try {
                    await db.collection(col).doc(id).delete();
                    showToast("Item removed");
                    if (cb) cb();
                } catch (e) { showToast(e.message, "error"); }
            }
        };

        window.fetchMaterials = async () => {
            const list = safeGet('admin-materials-list');
            if (!list) return;
            try {
                const snap = await db.collection('materials').orderBy('createdAt', 'desc').get();
                list.innerHTML = '';
                if (snap.empty) {
                    list.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">Empty list</td></tr>';
                    return;
                }
                snap.forEach(doc => {
                    const item = doc.data();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div class="table-title-stack">
                                <span class="table-title">${item.title}</span>
                                <span class="table-category">${item.subject}  ${item.language || item.lang || 'Bilingual'}</span>
                            </div>
                        </td>
                        <td class="text-center">
                            <span class="badge badge-info">${(item.assetType || 'PDF').toUpperCase()}</span>
                        </td>
                        <td class="text-center">
                            <span class="badge badge-success">ACTIVE</span>
                        </td>
                        <td>
                            <div class="action-btn-group">
                                <button class="action-btn btn-delete" title="Delete Material" onclick="deleteItem('materials','${doc.id}',fetchMaterials)">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    list.appendChild(row);
                });
                updateStats();
            } catch (e) { console.warn(e); }
        };

        window.fetchVideos = async () => {
            const list = safeGet('admin-videos-list');
            if (!list) return;
            try {
                const snap = await db.collection('videos').orderBy('createdAt', 'desc').get();
                list.innerHTML = '';
                snap.forEach(doc => {
                    const v = doc.data();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div class="table-title-stack">
                                <span class="table-title">${v.title}</span>
                                <span class="table-category">${v.subject} Collection</span>
                            </div>
                        </td>
                        <td class="text-center">
                            <span class="badge badge-warning">${(v.videoType || 'RECORDED').toUpperCase()}</span>
                        </td>
                        <td class="text-center">
                            <span class="table-stat">${v.lessonCount || 0} Lessons</span>
                        </td>
                        <td class="text-center">
                            <div class="action-btn-group" style="justify-content: center;">
                                <button class="action-btn btn-edit" title="Manage Playlist" onclick="openPlaylistModal('${doc.id}', '${(v.title || '').replace(/'/g, "\\'").replace(/"/g, "&quot;")}')">
                                    <i class="fas fa-list"></i> <span>Playlist</span>
                                </button>
                                <button class="action-btn btn-delete" title="Delete Course" onclick="deleteItem('videos','${doc.id}',fetchVideos)">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    list.appendChild(row);
                });
                updateStats();
            } catch (e) { }
        };

        window.togglePlaylistModal = (show) => {
            const modal = safeGet('playlist-modal');
            if (modal) modal.style.display = show ? 'flex' : 'none';
        };

        window.openPlaylistModal = (courseId, title) => {
            safeGet('manage-playlist-course-id').value = courseId;
            safeGet('playlist-modal-title').textContent = `Manage Playlist: ${title}`;
            safeGet('playlist-list-container').innerHTML = `<p style="color: var(--text-muted); padding: 10px;">Loading lessons...</p>`;
            window.fetchCourseLessons(courseId);
            togglePlaylistModal(true);
        };

        window.fetchCourseLessons = async (courseId) => {
            const container = safeGet('playlist-list-container');
            if (!container) return;
            try {
                const snap = await db.collection('videos').doc(courseId).collection('lessons').orderBy('createdAt', 'asc').get();
                container.innerHTML = '';
                if (snap.empty) {
                    container.innerHTML = `<p style="color: var(--text-muted); padding: 10px;">No lessons found. Add one above.</p>`;
                    return;
                }

                let idx = 1;
                snap.forEach(doc => {
                    const lesson = doc.data();
                    const div = document.createElement('div');
                    div.style = "display: flex; justify-content: space-between; align-items: center; padding: 16px; background: white; border-radius: 12px; border: 1px solid #e2e8f0;";
                    div.innerHTML = `
                        <div style="font-weight: 600; color: var(--primary-dark); display: flex; align-items: center; gap: 12px;">
                            <span style="display: flex; align-items: center; justify-content: center; width: 24px; height: 24px; background: var(--primary-light); color: var(--primary-green); border-radius: 6px; font-size: 0.7rem; font-weight: 800;">${idx < 10 ? '0' + idx : idx}</span>
                            <span>${lesson.title}</span>
                        </div>
                        <button type="button" class="action-btn" style="color: #ef4444; background: #fef2f2; font-size: 0.75rem; border: 1px solid #fee2e2;" onclick="deletePlaylistLesson('${courseId}', '${doc.id}')">
                            <i class="fas fa-trash-alt"></i> Remove
                        </button>
                    `;
                    container.appendChild(div);
                    idx++;
                });
            } catch (e) {
                container.innerHTML = `<p style="color: red; padding: 10px;">Error loading lessons: ${e.message}</p>`;
            }
        };

        window.deletePlaylistLesson = async (courseId, lessonId) => {
            if (confirm("Are you sure you want to delete this lesson?")) {
                try {
                    await db.collection('videos').doc(courseId).collection('lessons').doc(lessonId).delete();
                    showToast("Lesson deleted");
                    window.fetchCourseLessons(courseId);
                } catch (e) {
                    showToast(e.message, "error");
                }
            }
        };

        window.fetchTests = async () => {
            const list = safeGet('admin-tests-list');
            if (!list) return;
            try {
                const snap = await db.collection('tests').orderBy('createdAt', 'desc').get();
                list.innerHTML = '';
                if (snap.empty) {
                    list.innerHTML = '<tr><td colspan="4" style="text-align:center;">No tests found.</td></tr>';
                    return;
                }
                snap.forEach(doc => {
                    const t = doc.data();
                    const row = document.createElement('tr');
                    const classificationBadge = (t.category || 'MOCK').toUpperCase();
                    const badgeClass = classificationBadge === 'FULL' ? 'badge-warning' : 'badge-info';

                    row.innerHTML = `
                        <td>
                            <div class="table-title-stack">
                                <span class="table-title">${t.title}</span>
                                <span class="table-category">${t.examType} Suite</span>
                            </div>
                        </td>
                        <td class="text-center">
                            <span class="badge ${badgeClass}">${classificationBadge}</span>
                        </td>
                        <td class="text-center">
                            <span class="table-stat">${t.questions} Qns / ${t.duration || 180}m</span>
                        </td>
                        <td class="text-center">
                            <div class="action-btn-group" style="justify-content: center;">
                                <button class="action-btn btn-edit" title="Manage Questions" onclick="openQuestionsModal('${doc.id}', '${(t.title || '').replace(/'/g, "\\'").replace(/"/g, "&quot;")}')">
                                    <i class="fas fa-edit"></i> <span>Questions</span>
                                </button>
                                <button class="action-btn btn-delete" title="Delete Test" onclick="deleteItem('tests','${doc.id}',fetchTests)">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    list.appendChild(row);
                });
                updateStats();
            } catch (e) {
                list.innerHTML = `<tr><td colspan="4" style="color:red;">Error: ${e.message}</td></tr>`;
            }
        };

        // Questions Management Logic
        window.openQuestionsModal = (testId, testTitle) => {
            safeGet('manage-question-test-id').value = testId;
            safeGet('questions-modal-title').textContent = `Manage Questions: ${testTitle}`;
            safeGet('add-question-form').reset();
            toggleQuestionsModal(true);
            fetchTestQuestions(testId);
        };

        window.fetchTestQuestions = async (testId) => {
            const container = safeGet('questions-list-container');
            if (!container) return;
            container.innerHTML = '<p style="color:var(--text-muted);">Loading questions...</p>';

            try {
                const snap = await db.collection('tests').doc(testId).collection('questions').orderBy('createdAt', 'asc').get();
                if (snap.empty) {
                    container.innerHTML = '<div style="padding: 24px; text-align: center; background: #fff; border: 1px dashed #cbd5e1; border-radius: 12px; color: #64748b;">No questions added yet.</div>';
                    return;
                }

                container.innerHTML = '';
                let index = 1;
                snap.forEach(doc => {
                    const qData = doc.data();
                    const qEl = document.createElement('div');
                    qEl.style.cssText = 'background: white; padding: 20px; border-radius: 16px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; gap: 12px; transition: all 0.3s;';
                    qEl.onmouseover = () => qEl.style.borderColor = 'var(--primary-green)';
                    qEl.onmouseout = () => qEl.style.borderColor = '#e2e8f0';
                    qEl.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px;">
                            <h4 style="font-size: 1.05rem; font-weight: 700; color: var(--primary-dark); margin: 0; line-height: 1.5;">
                                <span style="background: var(--primary-light); color: var(--primary-green); width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 0.85rem; margin-right: 8px;">${index}</span>
                                ${qData.text}
                            </h4>
                            <button class="action-btn" style="color: #ef4444; background: #fef2f2; width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 8px; border: 1px solid #fee2e2;" onclick="deleteTestQuestion('${testId}', '${doc.id}')">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                        <ul style="list-style-type: none; padding: 0; margin: 0; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <li style="padding: 8px 12px; background: ${qData.correct === 'A' ? '#ecfdf5' : '#f8fafc'}; border: 1px solid ${qData.correct === 'A' ? '#10b981' : '#e2e8f0'}; border-radius: 8px;"><strong style="color: var(--primary-green);">A:</strong> ${qData.options.A}</li>
                            <li style="padding: 8px 12px; background: ${qData.correct === 'B' ? '#ecfdf5' : '#f8fafc'}; border: 1px solid ${qData.correct === 'B' ? '#10b981' : '#e2e8f0'}; border-radius: 8px;"><strong style="color: var(--primary-green);">B:</strong> ${qData.options.B}</li>
                            <li style="padding: 8px 12px; background: ${qData.correct === 'C' ? '#ecfdf5' : '#f8fafc'}; border: 1px solid ${qData.correct === 'C' ? '#10b981' : '#e2e8f0'}; border-radius: 8px;"><strong style="color: var(--primary-green);">C:</strong> ${qData.options.C}</li>
                            <li style="padding: 8px 12px; background: ${qData.correct === 'D' ? '#ecfdf5' : '#f8fafc'}; border: 1px solid ${qData.correct === 'D' ? '#10b981' : '#e2e8f0'}; border-radius: 8px;"><strong style="color: var(--primary-green);">D:</strong> ${qData.options.D}</li>
                        </ul>
                    `;
                    container.appendChild(qEl);
                    index++;
                });

            } catch (err) {
                console.error("Error fetching questions:", err);
                container.innerHTML = `<div style="color: red;">Error: ${err.message}</div>`;
            }
        };

        const addQuestionForm = safeGet('add-question-form');
        if (addQuestionForm) {
            addQuestionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const testId = safeGet('manage-question-test-id').value;
                if (!testId) return;

                const qData = {
                    text: safeGet('question-text').value,
                    options: {
                        A: safeGet('question-opt-a').value,
                        B: safeGet('question-opt-b').value,
                        C: safeGet('question-opt-c').value,
                        D: safeGet('question-opt-d').value
                    },
                    correct: safeGet('question-correct').value,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const ogText = submitBtn.textContent;
                    submitBtn.textContent = 'Adding...';
                    submitBtn.disabled = true;

                    await db.collection('tests').doc(testId).collection('questions').add(qData);

                    showToast("Question added successfully!", "success");
                    safeGet('add-question-form').reset();
                    // Keep test ID
                    safeGet('manage-question-test-id').value = testId;

                    submitBtn.textContent = ogText;
                    submitBtn.disabled = false;

                    // Refresh list
                    fetchTestQuestions(testId);
                } catch (err) {
                    showToast("Error adding question: " + err.message, "error");
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    submitBtn.textContent = 'Add Question';
                    submitBtn.disabled = false;
                }
            });
        }

        window.deleteTestQuestion = async (testId, questionId) => {
            if (await customConfirm("Delete Question", "Are you sure you want to delete this question? This action cannot be undone.")) {
                try {
                    await db.collection('tests').doc(testId).collection('questions').doc(questionId).delete();
                    showToast("Question deleted", "success");
                    fetchTestQuestions(testId);
                } catch (err) {
                    showToast("Error deleting question: " + err.message, "error");
                }
            }
        };

        window.fetchPYQs = async () => {
            const list = safeGet('admin-pyq-list');
            if (!list) return;
            try {
                const snap = await db.collection('pyqs').orderBy('createdAt', 'desc').get();
                list.innerHTML = '';
                snap.forEach(doc => {
                    const p = doc.data();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                                <td>
                                    <div class="table-title-stack">
                                        <span class="table-title">${p.name}</span>
                                        <span class="table-category">Official Release</span>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <span class="badge badge-info">${p.category}</span>
                                </td>
                                <td class="text-center">
                                    <div class="action-btn-group" style="justify-content: center;">
                                        <button class="action-btn btn-delete" title="Remove Document" onclick="deleteItem('pyqs','${doc.id}',fetchPYQs)">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </td>
                            `;
                    list.appendChild(row);
                });
            } catch (e) { }
        };

        // 6. Dashboard & User Stats
        window.updateStats = async () => {
            try {
                const [students, subjects, materials, videos] = await Promise.all([
                    db.collection('students').count().get(),
                    db.collection('subjects').count().get(),
                    db.collection('materials').count().get(),
                    db.collection('videos').count().get()
                ]);
                const sEl = safeGet('stat-students'); if (sEl) sEl.textContent = students.data().count;
                const subEl = safeGet('stat-subjects'); if (subEl) subEl.textContent = subjects.data().count;
                const aEl = safeGet('stat-assets'); if (aEl) aEl.textContent = materials.data().count + videos.data().count;
            } catch (e) {
                // Fallback if .count() is not supported in this env
                const [s, sub, m, v] = await Promise.all([
                    db.collection('students').get(),
                    db.collection('subjects').get(),
                    db.collection('materials').get(),
                    db.collection('videos').get()
                ]);
                const sEl = safeGet('stat-students'); if (sEl) sEl.textContent = s.size;
                const subEl = safeGet('stat-subjects'); if (subEl) subEl.textContent = sub.size;
                const aEl = safeGet('stat-assets'); if (aEl) aEl.textContent = m.size + v.size;
            }
        };

        window.refreshDashboard = () => {
            updateStats();
            fetchTimeline();
            showToast('Dashboard refreshed!', 'info');
        };

        const fetchTimeline = async () => {
            const timeline = safeGet('dashboard-timeline');
            if (!timeline) return;
            try {
                const [students, contents] = await Promise.all([
                    db.collection('students').orderBy('enrolled', 'desc').limit(3).get(),
                    db.collection('materials').orderBy('createdAt', 'desc').limit(2).get()
                ]);
                timeline.innerHTML = '';
                students.forEach(doc => {
                    const d = doc.data();
                    const item = document.createElement('div');
                    item.className = 'timeline-item';
                    item.innerHTML = `<i class="fas fa-user-plus" style="color: var(--primary-green); margin-top: 4px;"></i> <div><b>${d.name || 'Anonymous'}</b> joined the platform.</div>`;
                    timeline.appendChild(item);
                });
                contents.forEach(doc => {
                    const d = doc.data();
                    const item = document.createElement('div');
                    item.className = 'timeline-item';
                    item.innerHTML = `<i class="fas fa-cloud-upload-alt" style="color: var(--primary); margin-top: 4px;"></i> <div>New Content <b>${d.title}</b> published.</div>`;
                    timeline.appendChild(item);
                });
            } catch (e) { }
        };

        // 6.5. Student & User Management
        window.fetchUsers = async () => {
            const list = safeGet('admin-user-list');
            if (!list) return;
            list.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 40px;">Loading student directory...</td></tr>';
            try {
                // Ensure plans are loaded for the badges/buttons
                if (window.plansData.length === 0) {
                    const planSnap = await db.collection('plans').orderBy('price', 'asc').get();
                    window.plansData = planSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }

                const snap = await db.collection("students").get();
                list.innerHTML = '';
                if (snap.empty) {
                    list.innerHTML = '<tr><td colspan="5" style="text-align:center;">No students registered yet.</td></tr>';
                    return;
                }

                snap.forEach(docSnap => {
                    const user = docSnap.data();
                    const uid = docSnap.id;

                    // Dynamic Badge Logic
                    const userPlanId = user.plan || 'free';
                    const plansFallback = window.plansData || [{ id: 'free', name: 'Free Tier', color: '#6b7280' }];
                    const planInfo = plansFallback.find(p => p.id === userPlanId) || { name: 'Free', color: '#6b7280' };
                    const badgeColor = planInfo.color || '#6b7280';
                    const badgeBg = badgeColor + '15'; // ~8% opacity
                    const badgeBorder = badgeColor + '30'; // ~18% opacity

                    // Generate dynamic change buttons with icons
                    const planButtonsHtml = plansFallback.map(p => {
                        const pColor = p.color || '#6b7280';
                        return `
                        <button class="action-btn" 
                                style="color: ${pColor} !important; font-size: 0.75rem; border: 1px solid ${pColor}15; background: ${pColor}08;" 
                                onclick="setPlan('${uid}', '${p.id}')">
                            <i class="fas fa-arrow-up" style="font-size: 0.65rem; margin-right: 4px;"></i>${p.name.split(' ')[0]}
                        </button>`;
                    }).join('');

                    const row = document.createElement('tr');
                    row.id = `user-row-${uid}`;
                    row.innerHTML = `
                        <td class="text-center">
                            <button class="action-btn" onclick="toggleUserDetails('${uid}')" style="width: 28px; height: 28px; border-radius: 6px;">
                                <i class="fas fa-fingerprint"></i>
                            </button>
                        </td>
                        <td>
                            <div style="display:flex; align-items:center; gap:12px;">
                                <div style="width:36px; height:36px; border-radius:10px; background: linear-gradient(135deg, var(--primary-light), #F8FAFC); color:#1E293B; display:flex; align-items:center; justify-content:center; font-weight:800; border:1px solid #E2E8F0; text-shadow: 0 0 10px rgba(0,0,0,0.05);">
                                    ${(user.name || '?')[0].toUpperCase()}
                                </div>
                                <div class="table-title-stack">
                                    <span class="table-title">${user.name || 'Anonymous User'}</span>
                                    <span class="table-category">Enrolled ${user.enrolled ? user.enrolled.toDate().toLocaleDateString() : 'Today'}</span>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div style="font-weight: 600; color: #1e293b;">${user.email || 'N/A'}</div>
                            <div style="font-size: 11px; color: #94a3b8; letter-spacing: 0.5px;">SECURE IDENTIFIER: ${uid.substring(0, 8).toUpperCase()}</div>
                        </td>
                        <td class="text-center">
                            <span class="badge" style="background:${badgeBg}; color:${badgeColor}; border:1px solid ${badgeBorder}; font-weight: 800;">
                                ${planInfo.name.toUpperCase()}
                            </span>
                        </td>
                        <td class="text-center">
                            <div class="action-btn-group" style="justify-content: center;">
                                ${planButtonsHtml}
                            </div>
                        </td>
                    `;
                    list.appendChild(row);

                    const detailsRow = document.createElement('tr');
                    detailsRow.id = `user-details-${uid}`;
                    detailsRow.style.display = 'none';
                    detailsRow.innerHTML = `
                                <td colspan="5" style="background:rgba(241,245,249,0.5); padding:24px; border-radius:0 0 16px 16px;">
                                    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:24px;">
                                        <div><p style="color:#94a3b8; font-size:0.75rem; text-transform:uppercase; font-weight:700; margin-bottom:4px;">Unique ID</p><code style="font-size:0.85rem; background:#fff; padding:4px 8px; border:1px solid #e2e8f0; border-radius:6px;">${uid}</code></div>
                                        <div><p style="color:#94a3b8; font-size:0.75rem; text-transform:uppercase; font-weight:700; margin-bottom:4px;">Enrollment Date</p><p style="font-weight:600; color:var(--primary-dark);">${user.enrolled ? user.enrolled.toDate().toLocaleDateString() : 'N/A'}</p></div>
                                        <div><p style="color:#94a3b8; font-size:0.75rem; text-transform:uppercase; font-weight:700; margin-bottom:4px;">Last Activity</p><p style="font-weight:600; color:var(--primary-dark);">${user.lastLogin ? user.lastLogin.toDate().toLocaleString() : 'Never'}</p></div>
                                    </div>
                                </td>
                            `;
                    list.appendChild(detailsRow);
                });
            } catch (e) {
                list.innerHTML = '<tr><td colspan="5" style="color:red; text-align:center;">Error loading directory</td></tr>';
            }
        };

        window.toggleUserDetails = (uid) => {
            const el = safeGet(`user-details-${uid}`);
            const btn = document.querySelector(`#user-row-${uid} .toggle-btn`);
            if (el) {
                const isOpen = el.style.display === 'table-row';
                el.style.display = isOpen ? 'none' : 'table-row';
                if (btn) {
                    if (isOpen) btn.classList.remove('open');
                    else btn.classList.add('open');
                }
            }
        };

        window.setPlan = async (uid, newPlan) => {
            if (await customConfirm("Update Access Plan", `Grant ${newPlan.toUpperCase()} access to this student?`)) {
                try {
                    await db.collection('students').doc(uid).update({ plan: newPlan });
                    showToast(`Plan updated to ${newPlan.toUpperCase()}!`);
                    fetchUsers();
                } catch (e) { showToast(e.message, "error"); }
            }
        };

        window.filterStudents = () => {
            const q = safeGet("student-search-input").value.toLowerCase();
            const table = safeGet("admin-user-list");
            const rows = table.getElementsByTagName("tr");
            for (let i = 0; i < rows.length; i++) {
                if (rows[i].id && rows[i].id.startsWith('user-row-')) {
                    const nameCell = rows[i].getElementsByTagName("td")[1];
                    const emailCell = rows[i].getElementsByTagName("td")[2];
                    const txt = (nameCell.textContent + emailCell.textContent).toLowerCase();
                    rows[i].style.display = txt.includes(q) ? "" : "none";
                    const uid = rows[i].id.split('-')[2];
                    const details = safeGet(`user-details-${uid}`);
                    if (details) details.style.display = 'none';
                }
            }
        };

        window.exportDataToCSV = async () => {
            try {
                const snap = await db.collection("students").get();
                let csv = "ID,Name,Email,Plan\n";
                snap.forEach(d => {
                    const u = d.data();
                    csv += `${d.id},"${u.name || ''}","${u.email || ''}",${u.plan || 'free'}\n`;
                });
                const link = document.createElement("a");
                link.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
                link.download = "students_export.csv";
                link.click();
                showToast("Student data export complete!", "success");
            } catch (e) { showToast("Export failed: " + e.message, "error"); }
        };
        window.exportData = window.exportDataToCSV;

        window.saveHeroSettings = async () => {
            const notifText = safeGet('hero-notif-input')?.value?.trim();
            const countdownDate = safeGet('hero-countdown-input')?.value;
            if (!notifText && !countdownDate) {
                showToast('Please fill at least one field', 'error');
                return;
            }
            try {
                const data = {};
                if (notifText) data.notificationText = notifText;
                if (countdownDate) data.countdownDate = new Date(countdownDate).toString();
                await db.collection('siteConfig').doc('hero').set(data, { merge: true });
                showToast('Hero settings saved! Refresh homepage to see changes.', 'success');
            } catch (err) {
                console.error('Save hero error:', err);
                showToast('Error: ' + err.message, 'error');
            }
        };

        // Load hero settings into admin inputs
        window.fetchHeroSettings = async () => {
            try {
                const doc = await db.collection('siteConfig').doc('hero').get();
                if (doc.exists) {
                    const d = doc.data();
                    const notifInput = safeGet('hero-notif-input');
                    const countdownInput = safeGet('hero-countdown-input');
                    if (notifInput && d.notificationText) notifInput.value = d.notificationText;
                    if (countdownInput && d.countdownDate) {
                        const dt = new Date(d.countdownDate);
                        const iso = dt.toISOString().slice(0, 16);
                        countdownInput.value = iso;
                    }
                }
            } catch (err) { console.warn('Fetch hero settings error:', err); }
        };

        window.addAlert = () => {
            showToast("Alert feature coming soon!", "info");
        };

        window.fetchCMSData = () => {
            updateStats();
            fetchSubjects();
            fetchMaterials();
            fetchVideos();
            fetchTests();
            fetchPYQs();
            fetchUsers();
            fetchTimeline();
            fetchSettings();
            fetchTicker();
            fetchHeroSettings();
            fetchPlans();
        };

        // 6.6. Global Settings
        window.fetchSettings = async () => {
            try {
                const snap = await db.collection('settings').get();
                snap.forEach(doc => {
                    const data = doc.data();
                    const id = doc.id;
                    const el = document.querySelector(`input[onchange*="${id}"]`);
                    if (el) el.checked = data.enabled || false;
                });
            } catch (e) { }
        };

        window.updateGlobalSetting = async (key, enabled) => {
            try {
                await db.collection('settings').doc(key).set({ enabled, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
                showToast(`Setting ${key} updated.`);
            } catch (e) { showToast(e.message, "error"); }
        };

        // 7. File Upload System
        window.handleFileSelect = (input, nameElId, dropzoneId) => {
            const nameEl = safeGet(nameElId);
            const dropzone = safeGet(dropzoneId);
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const sizeMB = (file.size / 1024 / 1024).toFixed(1);
                if (nameEl) {
                    nameEl.textContent = `${file.name} (${sizeMB} MB)`;
                    nameEl.style.display = 'block';
                }
                if (dropzone) {
                    dropzone.style.borderColor = 'var(--primary-green)';
                    dropzone.style.background = '#ecfdf5';
                }
            }
        };

        // Upload file to Firebase Storage with progress tracking
        window.uploadFileToStorage = (file, folder, progressBarId, progressTextId, progressContainerId) => {
            return new Promise((resolve, reject) => {
                // Clean filename: replace spaces with underscores, add timestamp
                const timestamp = Date.now();
                const cleanName = file.name.replace(/\s+/g, '_');
                const storagePath = `${folder}/${timestamp}_${cleanName}`;
                const storageRef = storage.ref(storagePath);

                const progressContainer = safeGet(progressContainerId);
                const progressBar = safeGet(progressBarId);
                const progressText = safeGet(progressTextId);

                if (progressContainer) progressContainer.style.display = 'block';

                const uploadTask = storageRef.put(file);

                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
                        if (progressBar) progressBar.style.width = progress + '%';
                        if (progressText) progressText.textContent = `Uploading... ${progress}%`;
                    },
                    (error) => {
                        if (progressText) progressText.textContent = 'Upload failed!';
                        reject(error);
                    },
                    async () => {
                        const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                        if (progressText) progressText.textContent = 'Upload complete!';
                        if (progressBar) progressBar.style.width = '100%';
                        resolve({ url: downloadURL, path: storagePath, name: file.name });
                    }
                );
            });
        };

        // Drag and drop handlers
        ['material-dropzone', 'video-dropzone'].forEach(id => {
            const el = safeGet(id);
            if (!el) return;
            el.addEventListener('dragover', (e) => { e.preventDefault(); el.style.borderColor = 'var(--primary-green)'; el.style.background = '#ecfdf5'; });
            el.addEventListener('dragleave', () => { el.style.borderColor = '#cbd5e1'; el.style.background = '#f8fafc'; });
            el.addEventListener('drop', (e) => {
                e.preventDefault();
                el.style.borderColor = 'var(--primary-green)';
                const inputId = id === 'material-dropzone' ? 'material-file' : 'video-file';
                const nameId = id === 'material-dropzone' ? 'material-file-name' : 'video-file-name';
                const input = safeGet(inputId);
                if (input && e.dataTransfer.files.length > 0) {
                    input.files = e.dataTransfer.files;
                    handleFileSelect(input, nameId, id);
                }
            });
        });

        // 7b. Seed Mock Data to Firebase
        window.seedMockDataToFirebase = async () => {
            if (!window.MOCK_DATA) {
                showToast('mock-data.js not loaded!', 'error');
                return;
            }
            if (!confirm('This will upload all sample data to Firebase. Existing data in these collections will NOT be deleted. Continue?')) return;

            const btn = safeGet('seed-btn');
            const progress = safeGet('seed-progress');
            const progressBar = safeGet('seed-progress-bar');
            const statusEl = safeGet('seed-status');

            if (btn) { btn.disabled = true; btn.textContent = 'Uploading...'; }
            if (progress) progress.style.display = 'block';

            const tasks = [];
            const md = MOCK_DATA;

            // 1. Exam Categories -> subjects collection
            (md.examCategories || []).forEach(cat => tasks.push({
                collection: 'subjects',
                data: { name: cat.name, shortCode: cat.shortCode, color: cat.color, bg: cat.bg, createdAt: firebase.firestore.FieldValue.serverTimestamp() }
            }));

            // 2. CA PDFs -> materials collection
            (md.currentAffairsPDFs || []).forEach(pdf => tasks.push({
                collection: 'materials',
                data: { title: pdf.title, subject: pdf.description, assetType: pdf.category === 'daily' ? 'daily_ca' : pdf.category === 'weekly' ? 'weekly_ca' : pdf.category === 'monthly' ? 'monthly_ca' : 'gk_static', pdfUrl: pdf.url, createdAt: firebase.firestore.FieldValue.serverTimestamp() }
            }));

            // 3. Mock Tests -> tests collection
            (md.freeMockTests || []).forEach(test => tasks.push({
                collection: 'tests',
                data: { title: test.title, examType: test.category, questions: test.questions, duration: test.duration, createdAt: firebase.firestore.FieldValue.serverTimestamp() }
            }));

            // 4. Courses -> courses collection
            (md.courses || []).forEach(course => tasks.push({
                collection: 'courses',
                data: { title: course.title, tag: course.tag, description: course.description, price: course.price, period: course.period, image: course.image, createdAt: firebase.firestore.FieldValue.serverTimestamp() }
            }));

            // 5. Testimonials -> testimonials collection
            (md.testimonials || []).forEach(t => tasks.push({
                collection: 'testimonials',
                data: { text: t.text, name: t.name, achievement: t.achievement, color: t.color, bg: t.bg, borderColor: t.borderColor, createdAt: firebase.firestore.FieldValue.serverTimestamp() }
            }));

            // 6. Ticker Items -> ticker collection
            (md.tickerItems || []).forEach(t => tasks.push({
                collection: 'ticker',
                data: { badge: t.badge, text: t.text, createdAt: firebase.firestore.FieldValue.serverTimestamp() }
            }));

            // 7. Subscription Plans -> plans collection
            (md.plans || []).forEach(p => tasks.push({
                collection: 'plans',
                customId: p.id,
                data: {
                    name: p.name,
                    price: p.price,
                    period: p.period,
                    features: p.features,
                    buttonText: p.buttonText,
                    popular: p.popular || false,
                    badge: p.badge || '',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }
            }));

            let completed = 0;
            const total = tasks.length;

            for (const task of tasks) {
                try {
                    if (task.customId) {
                        await db.collection(task.collection).doc(task.customId).set(task.data);
                    } else {
                        await db.collection(task.collection).add(task.data);
                    }
                } catch (err) {
                    console.error(`Seed error (${task.collection}):`, err);
                }
                completed++;
                const pct = Math.round((completed / total) * 100);
                if (progressBar) progressBar.style.width = pct + '%';
                if (statusEl) statusEl.textContent = `Uploading... ${completed}/${total} items (${pct}%)`;
            }

            if (statusEl) statusEl.textContent = `Done! ${completed} items uploaded to Firebase.`;
            if (btn) { btn.disabled = false; btn.textContent = 'Upload Mock Data to Firebase'; }
            showToast(`${completed} items seeded to Firebase!`, 'success');
        };

        // 8. Form Handlers (with File Upload Support)
        document.addEventListener('submit', async (e) => {
            const formId = e.target.id;
            if (!['add-subject-form', 'add-material-form', 'add-video-form', 'add-test-form', 'add-pyq-form', 'add-lesson-form'].includes(formId)) return;

            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            if (btn) { btn.disabled = true; btn.textContent = 'Saving...'; }

            try {
                if (formId === 'add-subject-form') {
                    const id = safeGet('edit-subject-id').value;
                    const payload = {
                        name: safeGet('new-subject-name').value,
                        category: safeGet('new-subject-category').value,
                        syllabus: safeGet('new-subject-syllabus').value,
                        pattern: safeGet('new-subject-pattern').value,
                        eligibility: safeGet('new-subject-eligibility').value,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    if (id) await db.collection('subjects').doc(id).update(payload);
                    else {
                        payload.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        await db.collection('subjects').add(payload);
                    }
                    showToast("Exam saved!"); toggleModal('add-subject-modal', false); fetchSubjects();

                } else if (formId === 'add-material-form') {
                    const fileInput = safeGet('material-file');
                    const urlInput = safeGet('material-url');
                    let pdfUrl = urlInput ? urlInput.value : '';
                    let fileName = '';
                    let storagePath = '';

                    // Upload file if selected
                    if (fileInput && fileInput.files && fileInput.files[0]) {
                        if (btn) btn.textContent = 'Uploading PDF...';
                        const result = await uploadFileToStorage(
                            fileInput.files[0], 'pdfs',
                            'material-progress-bar', 'material-progress-text', 'material-upload-progress'
                        );
                        pdfUrl = result.url;
                        fileName = result.name;
                        storagePath = result.path;
                    }

                    if (!pdfUrl) { showToast('Please upload a file or paste a link!', 'error'); return; }

                    await db.collection('materials').add({
                        title: safeGet('material-title').value,
                        subject: safeGet('material-subject').value,
                        assetType: safeGet('material-type').value,
                        pdfUrl: pdfUrl,
                        fileName: fileName || safeGet('material-title').value,
                        storagePath: storagePath,
                        uploadedFile: !!storagePath,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showToast("Material uploaded & saved!"); toggleModal('material-modal', false); fetchMaterials();

                } else if (formId === 'add-video-form') {
                    const fileInput = safeGet('video-pdf-file');
                    let pdfUrl = '';
                    let fileName = '';
                    let storagePath = '';

                    // Upload file if selected
                    if (fileInput && fileInput.files && fileInput.files[0]) {
                        if (btn) btn.textContent = 'Uploading PDF...';
                        const result = await uploadFileToStorage(
                            fileInput.files[0], 'course_syllabuses',
                            'video-pdf-progress-bar', 'video-pdf-progress-text', 'video-pdf-progress'
                        );
                        pdfUrl = result.url;
                        fileName = result.name;
                        storagePath = result.path;
                    }

                    await db.collection('videos').add({
                        title: safeGet('video-title').value,
                        subject: safeGet('video-subject').value,
                        videoType: safeGet('video-type').value,
                        description: safeGet('video-desc').value,
                        syllabusUrl: pdfUrl,
                        syllabusFileName: fileName || '',
                        syllabusStoragePath: storagePath,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showToast("Video Course created!"); toggleModal('video-modal', false); fetchVideos();

                } else if (formId === 'add-lesson-form') {
                    const courseId = safeGet('manage-playlist-course-id').value;
                    const fileInput = safeGet('lesson-file');
                    const urlInput = safeGet('lesson-url');
                    const pdfInput = safeGet('lesson-pdf-file');

                    let videoUrl = urlInput ? urlInput.value : '';
                    let videoFileName = '';
                    let videoStoragePath = '';

                    let pdfUrl = '';
                    let pdfFileName = '';
                    let pdfStoragePath = '';

                    // Upload Video if selected
                    if (fileInput && fileInput.files && fileInput.files[0]) {
                        if (btn) btn.textContent = 'Uploading Video...';
                        const result = await uploadFileToStorage(
                            fileInput.files[0], `videos/${courseId}/lessons`,
                            'lesson-progress-bar', 'lesson-progress-text', 'lesson-upload-progress'
                        );
                        videoUrl = result.url;
                        videoFileName = result.name;
                        videoStoragePath = result.path;
                    }

                    // Upload PDF if selected
                    if (pdfInput && pdfInput.files && pdfInput.files[0]) {
                        if (btn) btn.textContent = 'Uploading PDF...';
                        const result = await uploadFileToStorage(
                            pdfInput.files[0], `videos/${courseId}/lessons_resources`,
                            'lesson-pdf-progress-bar', 'lesson-pdf-progress-text', 'lesson-pdf-progress'
                        );
                        pdfUrl = result.url;
                        pdfFileName = result.name;
                        pdfStoragePath = result.path;
                    }

                    if (!videoUrl) { showToast('Please upload a video file or paste a link!', 'error'); return; }

                    await db.collection('videos').doc(courseId).collection('lessons').add({
                        title: safeGet('lesson-title').value,
                        url: videoUrl,
                        notes: safeGet('lesson-notes').value,
                        fileName: videoFileName || safeGet('lesson-title').value,
                        storagePath: videoStoragePath,
                        uploadedFile: !!videoStoragePath,
                        resourcePdfUrl: pdfUrl,
                        resourcePdfName: pdfFileName,
                        resourcePdfStorage: pdfStoragePath,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showToast("Lesson added to Playlist!");
                    fetchCourseLessons(courseId); // Refresh list

                } else if (formId === 'add-test-form') {
                    await db.collection('tests').add({
                        title: safeGet('test-title').value,
                        examType: safeGet('test-exam-type').value,
                        questions: safeGet('test-questions').value,
                        category: safeGet('test-category').value,
                        duration: safeGet('test-duration').value,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showToast("Mock Test created!"); toggleModal('test-modal', false); fetchTests();

                } else if (formId === 'add-pyq-form') {
                    await db.collection('pyqs').add({
                        name: safeGet('pyq-name').value,
                        category: safeGet('pyq-category').value,
                        url: safeGet('pyq-url').value,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showToast("PYQ Document saved!"); toggleModal('pyq-modal', false); fetchPYQs();
                }
                e.target.reset();
                // Reset file upload UI
                ['material-file-name', 'video-file-name', 'lesson-file-name', 'video-pdf-file-name', 'lesson-pdf-file-name'].forEach(id => { const el = safeGet(id); if (el) el.style.display = 'none'; });
                ['material-upload-progress', 'video-upload-progress', 'lesson-upload-progress', 'video-pdf-progress', 'lesson-pdf-progress'].forEach(id => { const el = safeGet(id); if (el) el.style.display = 'none'; });
                ['material-dropzone', 'video-dropzone', 'lesson-dropzone', 'video-pdf-dropzone', 'lesson-pdf-dropzone'].forEach(id => { const el = safeGet(id); if (el) { el.style.borderColor = '#cbd5e1'; el.style.background = '#f8fafc'; } });
            } catch (err) {
                showToast(`Save Error: ${err.message}`, "error");
            } finally {
                if (btn) { btn.disabled = false; btn.textContent = 'Upload & Save'; }
            }
        });

        // 8. Authentication & Bootstrapping
        let isAdminAuthed = false;

        auth.onAuthStateChanged((user) => {
            if (user && user.email === ADMIN_CONFIG.email) {
                isAdminAuthed = true;
                console.log("Admin Authorized & Data Linked.");
                showToast("Welcome back, Admin!", "success");
                fetchCMSData();
            } else if (user) {
                // Logged in but not admin
                isAdminAuthed = false;
                console.warn("Logged in as", user.email, "but admin is", ADMIN_CONFIG.email);
                showToast("Signed in as " + user.email + ". Admin access requires " + ADMIN_CONFIG.email, "error");
                // Still try to load data - Firestore rules will decide access
                fetchCMSData();
            } else {
                // Not logged in at all
                isAdminAuthed = false;
                console.warn("No user logged in. Admin features may be limited.");
                showToast("Not signed in. Some features may require admin login.", "info");
                // Still try to load data - Firestore rules will decide access
                fetchCMSData();
            }
        });


        window.toggleMobileSidebar = () => {
            const sidebar = document.getElementById('admin-sidebar');
            if (sidebar) {
                sidebar.classList.toggle('mobile-active');
            }
        };

        window.logout = () => auth.signOut().then(() => {
            showToast("Logged out. Redirecting...");
            setTimeout(() => location.href = 'index.html', 1000);
        });

        // Global error handler
        window.onerror = (m, u, l) => {
            console.error(`Error at line ${l}: ${m}`);
            showToast(`Script error: ${m}`, "error");
        };
    </script>
</body>

</html>